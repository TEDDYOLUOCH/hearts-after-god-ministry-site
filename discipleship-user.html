<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard | Discipleship Portal | Hearts After God Ministry</title>
  <meta name="description" content="Your personal discipleship dashboard.">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/css/tailwind.css">
  <link rel="stylesheet" href="assets/css/discipleship.css">
  <style>
    .sidebar-link.active {
      background: linear-gradient(to right, var(--color-gold), var(--color-purple));
      color: var(--color-blue);
      font-weight: bold;
    }
    .sidebar-link {
      transition: background 0.2s, color 0.2s;
    }
    .sidebar-link:hover {
      background: var(--color-bg-alt);
      color: var(--color-purple);
    }
    .scrollbar::-webkit-scrollbar {
      width: 8px;
      background: var(--color-bg-alt);
    }
    .scrollbar::-webkit-scrollbar-thumb {
      background: #c7d2fe;
      border-radius: 4px;
    }
    /* Full-page background image + gradient overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: -2;
      background: url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1600&q=80') center center/cover no-repeat;
      filter: brightness(0.7);
    }
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: -1;
      background: linear-gradient(135deg, rgba(30,64,175,0.85) 0%, rgba(245,158,11,0.35) 40%, rgba(124,58,237,0.85) 100%);
      pointer-events: none;
    }
    /* Card and section backgrounds */
    .dashboard-section, .dashboard-card, .sidebar, .navbar, .footer {
      background: rgba(255,255,255,0.95) !important;
      backdrop-filter: blur(2px);
    }
    /* Section headings */
    .section-title {
      color: var(--color-purple);
      font-weight: bold;
    }
    /* Brand color highlights */
    .brand-gold { color: var(--color-gold); }
    .brand-blue { color: var(--color-blue); }
    .brand-purple { color: var(--color-purple); }
    .brand-red { color: var(--color-red); }
    .border-gold { border-color: var(--color-gold) !important; }
    .border-blue { border-color: var(--color-blue) !important; }
    .border-purple { border-color: var(--color-purple) !important; }
    .border-red { border-color: var(--color-red) !important; }
    /* Button gradients */
    .btn-gold {
      background: linear-gradient(90deg, var(--color-gold) 0%, var(--color-purple) 100%);
      color: #fff;
      font-weight: bold;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .btn-gold:hover {
      box-shadow: 0 4px 16px rgba(245,158,11,0.25), 0 2px 8px rgba(124,58,237,0.15);
      transform: translateY(-2px) scale(1.03);
    }
    /* Footer links */
    .footer a:hover { color: var(--color-gold) !important; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Top Navbar -->
  <header class="navbar bg-white/95 backdrop-blur sticky top-0 z-30 shadow">
    <nav class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3">
        <img src="assets/images/WhatsApp Image 2025-07-04 at 17.27.34_37ced412.jpg" alt="Logo" class="h-10 w-10 rounded-full border-2 border-gold shadow" />
        <span class="text-xl font-bold brand-blue">Hearts After God</span>
      </div>
      <div class="hidden md:flex gap-8 font-semibold text-white text-lg mx-auto relative" id="nav-links">
        <ul class="flex gap-8">
          <li><a href="index.html" class="nav-link" id="nav-home">Home</a></li>
          <li><a href="about.html" class="nav-link" id="nav-about">About</a></li>
          <li><a href="vision.html" class="nav-link" id="nav-vision">Vision</a></li>
          <li><a href="events.html" class="nav-link" id="nav-events">Events</a></li>
          <li><a href="sermons.html" class="nav-link" id="nav-sermons">Sermons</a></li>
          <li><a href="blog.html" class="nav-link" id="nav-blog">Blog</a></li>
          <li><a href="gallery.html" class="nav-link" id="nav-gallery">Gallery</a></li>
          <li><a href="discipleship.html" class="nav-link" id="nav-discipleship">Discipleship</a></li>
          <li><a href="missions.html" class="nav-link" id="nav-missions">Missions</a></li>
          <li><a href="contact.html" class="nav-link" id="nav-contact">Contact</a></li>
        </ul>
        <span id="nav-underline" class="nav-underline" style="width: 0;"></span>
      </div>
      <div class="relative group">
        <button class="flex items-center gap-2 px-4 py-2 btn-gold rounded-full shadow hover:scale-105 transition">
          <span id="nav-user-avatar" class="bg-gold brand-blue rounded-full w-8 h-8 flex items-center justify-center font-bold"></span>
          <span id="nav-user-name" class="hidden md:inline"></span>
          <i class="fa fa-chevron-down ml-1"></i>
        </button>
        <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 z-50 hidden group-hover:block">
          <a href="#profile" class="block px-4 py-2 brand-blue hover:bg-gray-100">View Profile</a>
          <a href="#settings" class="block px-4 py-2 brand-blue hover:bg-gray-100">Settings</a>
          <button id="logout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">Logout</button>
        </div>
      </div>
    </nav>
  </header>

  <div class="flex flex-1 w-full max-w-7xl mx-auto mt-6 gap-6">
    <!-- Sidebar -->
    <aside class="sidebar hidden md:flex flex-col w-56 bg-white/90 rounded-2xl shadow-lg p-6 gap-2 h-fit sticky top-24 self-start">
      <a href="#dashboard" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg brand-blue"><i class="fa fa-home"></i> Dashboard</a>
      <a href="#lessons" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg brand-blue"><i class="fa fa-book-open"></i> Lessons</a>
      <a href="#achievements" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg brand-blue"><i class="fa fa-trophy"></i> Achievements</a>
      <a href="#community" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg brand-blue"><i class="fa fa-users"></i> Community</a>
      <a href="#community-moderation" class="sidebar-link admin-only flex items-center gap-3 px-4 py-3 rounded-lg brand-blue hidden"><i class="fa fa-shield-alt"></i> Moderation</a>
      <a href="#support" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg brand-blue"><i class="fa fa-question-circle"></i> Support</a>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col gap-8 scrollbar overflow-y-auto">
      <!-- Dashboard Section -->
      <section id="dashboard" class="dashboard-section rounded-2xl shadow-xl p-8 mb-2">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-6">
          <div>
            <h2 class="text-3xl font-bold section-title mb-1">Welcome, <span id="user-name">Disciple</span>!</h2>
            <p class="text-gray-600 text-lg">Ready to continue your discipleship journey?</p>
          </div>
                  <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-gold rounded-full flex items-center justify-center brand-blue text-3xl font-bold shadow-lg border-4 border-white" id="user-avatar">üë§</div>
          <div>
            <div class="font-bold brand-blue" id="user-email">user@email.com</div>
            <span class="bg-blue-100 brand-blue text-xs px-3 py-1 rounded-full font-semibold">Active Learner</span>
          </div>
        </div>
        </div>
        <div class="grid md:grid-cols-4 gap-6 mb-6">
          <div class="bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-book-open text-2xl text-blue-700 mb-2"></i>
            <div class="text-2xl font-bold text-blue-900" id="summary-lessons">4</div>
            <div class="text-sm text-blue-800">Lessons</div>
          </div>
          <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-percent text-2xl text-yellow-600 mb-2"></i>
            <div class="text-2xl font-bold text-yellow-700" id="summary-progress">40%</div>
            <div class="text-sm text-yellow-700">Progress</div>
          </div>
          <div class="bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-trophy text-2xl text-purple-700 mb-2"></i>
            <div class="text-2xl font-bold text-purple-700" id="summary-badges">2</div>
            <div class="text-sm text-purple-700">Badges</div>
          </div>
          <div class="bg-gradient-to-br from-green-100 to-green-200 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-arrow-right text-2xl text-green-700 mb-2"></i>
            <button class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-full font-bold shadow hover:scale-105 transition" id="continue-btn">Continue Learning</button>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <!-- Next Lesson Widget -->
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 shadow flex flex-col justify-between">
            <div class="flex items-center gap-3 mb-2">
              <i class="fa fa-arrow-circle-right text-blue-600 text-2xl"></i>
              <span class="font-bold text-blue-900 text-lg">Next Lesson</span>
            </div>
            <div class="font-semibold text-blue-900 mb-1" id="next-lesson-title">Day 2: Prayer & Devotion</div>
            <div class="text-sm text-gray-600 mb-2">Building a daily habit of prayer, worship, and Bible study.</div>
            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition text-sm" id="next-lesson-btn">Continue</button>
          </div>
          <!-- Recent Activity Widget -->
          <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 shadow flex flex-col justify-between">
            <div class="flex items-center gap-3 mb-2">
              <i class="fa fa-history text-green-600 text-2xl"></i>
              <span class="font-bold text-green-900 text-lg">Recent Activity</span>
            </div>
            <ul class="text-sm text-gray-700 space-y-1" id="recent-activity">
              <li>‚úîÔ∏è Completed Day 1: Foundations of Faith</li>
              <li>üèÜ Earned badge: First Steps</li>
              <li>‚è≥ Started Day 2: Prayer & Devotion</li>
            </ul>
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl p-6 shadow-lg flex items-center gap-4">
          <svg class="w-8 h-8 opacity-80" fill="currentColor" viewBox="0 0 24 24">
            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
          </svg>
          <p class="text-lg font-medium mb-0" id="motivation-text">"But you will receive power when the Holy Spirit comes on you; and you will be my witnesses..." ‚Äî Acts 1:8</p>
        </div>
      </section>

      <!-- Lessons Section -->
      <section id="lessons" class="bg-white/95 rounded-2xl shadow-xl p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-blue-900">Your Lessons</h2>
          <input type="text" placeholder="Search lessons..." class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" />
        </div>
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Example Lesson Card -->
          <div class="group bg-gradient-to-r from-yellow-50 to-yellow-100 border-l-4 border-yellow-500 rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105 flex flex-col justify-between cursor-pointer" onclick="showLessonModal(1)">
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-blue-900">Day 1: Foundations of Faith</span>
                <span class="bg-yellow-500 text-blue-900 text-xs px-3 py-1 rounded-full font-bold shadow-sm">Completed</span>
              </div>
              <p class="text-gray-700 mb-4 leading-relaxed">Understanding salvation, grace, and your new identity in Christ.</p>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600 mt-2">
              <i class="fa fa-clock"></i> <span>45 min</span>
              <i class="fa fa-clipboard-check"></i> <span>Quiz: 95%</span>
              <i class="fa fa-check-circle text-green-600"></i>
            </div>
            <div class="flex gap-2 mt-4">
              <button class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition text-sm">Review</button>
            </div>
          </div>
          <div class="group bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-500 rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105 flex flex-col justify-between cursor-pointer" onclick="showLessonModal(2)">
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-blue-900">Day 2: Prayer & Devotion</span>
                <span class="bg-blue-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm">In Progress</span>
              </div>
              <p class="text-gray-700 mb-4 leading-relaxed">Building a daily habit of prayer, worship, and Bible study.</p>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600 mt-2">
              <i class="fa fa-clock"></i> <span>30 min</span>
              <i class="fa fa-spinner text-blue-600 animate-spin"></i> <span>60% complete</span>
            </div>
            <div class="flex gap-2 mt-4">
              <button class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition text-sm">Continue</button>
            </div>
          </div>
          <div class="group bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-500 rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105 flex flex-col justify-between">
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-blue-900">Day 3: Community & Fellowship</span>
                <span class="bg-purple-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm">Locked</span>
              </div>
              <p class="text-gray-700 mb-4 leading-relaxed">The importance of spiritual family and accountability.</p>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600 mt-2">
              <i class="fa fa-users"></i> <span>Group activity</span>
              <i class="fa fa-lock text-purple-600"></i> <span>Unlock after Day 2</span>
            </div>
            <div class="flex gap-2 mt-4">
              <button class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg font-bold shadow text-sm cursor-not-allowed" disabled>Locked</button>
            </div>
          </div>
          <div class="group bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500 rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:scale-105 flex flex-col justify-between">
            <div>
              <div class="flex justify-between items-center mb-2">
                <span class="font-semibold text-blue-900">Day 4: Spiritual Gifts & Calling</span>
                <span class="bg-red-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm">Locked</span>
              </div>
              <p class="text-gray-700 mb-4 leading-relaxed">Discovering your spiritual gifts and God's purpose for your life.</p>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600 mt-2">
              <i class="fa fa-gift"></i> <span>Gift assessment</span>
              <i class="fa fa-lock text-red-600"></i> <span>Unlock after Day 3</span>
            </div>
            <div class="flex gap-2 mt-4">
              <button class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg font-bold shadow text-sm cursor-not-allowed" disabled>Locked</button>
            </div>
          </div>
        </div>
        <!-- Lesson Details Modal -->
        <div id="lesson-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 relative">
            <button onclick="closeLessonModal()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            <div id="lesson-modal-content">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- Announcements Section -->
      <section id="announcements" class="bg-white/95 rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-2">
          <i class="fa fa-bullhorn text-gold"></i> Ministry Announcements
        </h2>
        <div id="user-announcements-list" class="space-y-4">
          <!-- Announcements will be loaded here -->
        </div>
      </section>

      <!-- Achievements Section -->
      <section id="achievements" class="bg-white/95 rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold text-blue-900 mb-6">Achievements & Badges</h2>
        <div class="flex flex-wrap gap-6">
          <div class="flex flex-col items-center bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-xl p-6 shadow w-48 relative group">
            <i class="fa fa-star text-yellow-500 text-3xl mb-2"></i>
            <div class="font-bold text-blue-900">First Steps</div>
            <div class="text-xs text-gray-600 mb-2">Completed your first lesson</div>
            <div class="text-xs text-yellow-700 font-bold">Unlocked</div>
            <div class="absolute left-1/2 -translate-x-1/2 bottom-2 w-10/12 h-2 bg-yellow-200 rounded-full overflow-hidden">
              <div class="bg-yellow-500 h-2 rounded-full" style="width:100%"></div>
            </div>
            <div class="absolute top-2 right-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition">Unlocked! üéâ</div>
          </div>
          <div class="flex flex-col items-center bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl p-6 shadow w-48 relative group">
            <i class="fa fa-bolt text-purple-500 text-3xl mb-2"></i>
            <div class="font-bold text-blue-900">Quick Learner</div>
            <div class="text-xs text-gray-600 mb-2">Completed 2 lessons in a week</div>
            <div class="text-xs text-purple-700 font-bold">Unlocked</div>
            <div class="absolute left-1/2 -translate-x-1/2 bottom-2 w-10/12 h-2 bg-purple-200 rounded-full overflow-hidden">
              <div class="bg-purple-500 h-2 rounded-full" style="width:100%"></div>
            </div>
            <div class="absolute top-2 right-2 bg-purple-500 text-white text-xs px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition">Unlocked! üöÄ</div>
          </div>
          <div class="flex flex-col items-center bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-6 shadow w-48 opacity-60 relative group">
            <i class="fa fa-users text-blue-500 text-3xl mb-2"></i>
            <div class="font-bold text-blue-900">Community Builder</div>
            <div class="text-xs text-gray-600 mb-2">Joined a study group</div>
            <div class="text-xs text-blue-700 font-bold">Locked</div>
            <div class="absolute left-1/2 -translate-x-1/2 bottom-2 w-10/12 h-2 bg-blue-200 rounded-full overflow-hidden">
              <div class="bg-blue-500 h-2 rounded-full" style="width:40%"></div>
            </div>
            <div class="absolute top-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition">Complete 1 group activity to unlock</div>
          </div>
        </div>
      </section>

      <!-- Certificates Section -->
      <section id="certificates" class="bg-white/95 rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold text-blue-900 mb-6">My Certificates</h2>
        <div id="certificates-list" class="flex flex-wrap gap-6"></div>
        <!-- Certificate Preview Modal -->
        <div id="certificate-preview-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 relative">
            <button onclick="closeCertificatePreview()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            <div id="certificate-preview-content" class="flex flex-col items-center justify-center"></div>
            <div class="flex flex-col md:flex-row justify-end mt-4 gap-2">
              <button id="download-certificate-btn" class="btn-gold px-4 py-2 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2" aria-label="Download certificate as PNG" title="Download certificate as PNG"><i class="fa fa-download"></i> <span id="download-png-text">Download PNG</span> <span id="download-png-spinner" class="hidden animate-spin ml-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg></span></button>
              <button id="download-certificate-pdf-btn" class="btn-gold px-4 py-2 rounded-lg font-semibold bg-red-600 hover:bg-red-700 text-white flex items-center gap-2" aria-label="Download certificate as PDF" title="Download certificate as PDF"><i class="fa fa-file-pdf"></i> <span id="download-pdf-text">Download PDF</span> <span id="download-pdf-spinner" class="hidden animate-spin ml-2"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg></span></button>
              <button onclick="downloadCertificateSimple()" class="btn-gold px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-700 text-white flex items-center gap-2" title="Download as text file (fallback)"><i class="fa fa-file-text"></i> <span>Download TXT</span></button>
            </div>
          </div>
        </div>
      </section>

      <!-- Community Section (for all users) -->
      <section id="community" class="bg-white/95 rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-purple-700 mb-6 flex items-center gap-2">
          <i class="fa fa-users"></i> Community
        </h2>
        <!-- Announcements -->
        <div class="mb-8">
          <h3 class="text-xl font-bold text-gold mb-2 flex items-center gap-2"><i class="fa fa-bullhorn"></i> Announcements</h3>
          <ul id="community-announcements" class="bg-white rounded-lg shadow p-4 space-y-2 text-sm"></ul>
        </div>
        <!-- Leaderboard -->
        <div class="mb-8">
          <h3 class="text-xl font-bold text-blue-700 mb-2 flex items-center gap-2"><i class="fa fa-trophy"></i> Leaderboard</h3>
          <table class="w-full bg-white rounded-lg shadow text-sm">
            <thead><tr class="bg-blue-50"><th class="py-2 px-3 text-left">Avatar</th><th class="py-2 px-3 text-left">Name</th><th class="py-2 px-3 text-left">Lessons</th><th class="py-2 px-3 text-left">Badges</th><th class="py-2 px-3 text-left">Status</th></tr></thead>
            <tbody id="community-leaderboard"></tbody>
          </table>
        </div>
        <!-- Group Chat -->
        <div>
          <h3 class="text-xl font-bold text-green-700 mb-2 flex items-center gap-2"><i class="fa fa-comments"></i> Group Chat</h3>
          <div id="community-chat-messages" class="bg-white rounded-lg shadow p-4 h-48 overflow-y-auto mb-2 flex flex-col gap-2 text-sm"></div>
          <form id="community-chat-form" class="flex gap-2"><input id="community-chat-input" type="text" class="flex-1 px-2 py-1 border rounded" placeholder="Type a message..." required /><button type="submit" class="bg-green-600 text-white px-4 py-1 rounded font-bold">Send</button></form>
        </div>
      </section>

      <!-- Support Section -->
      <section id="support" class="bg-white/95 rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-blue-900 mb-6 flex items-center gap-2">
          <i class="fa fa-life-ring text-gold"></i> Support & Help
        </h2>
        
        <!-- Support Options -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-question-circle text-blue-600 text-3xl mb-2"></i>
            <div class="font-bold text-blue-900 mb-1">FAQs</div>
            <p class="text-sm text-gray-600 mb-2 text-center">Find answers to common questions about your discipleship journey.</p>
            <button onclick="showFAQs()" class="text-blue-600 font-bold hover:underline">View FAQs</button>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-ticket text-green-600 text-3xl mb-2"></i>
            <div class="font-bold text-blue-900 mb-1">Support Tickets</div>
            <p class="text-sm text-gray-600 mb-2 text-center">Create a support ticket for personalized assistance.</p>
            <button onclick="showSupportTickets()" class="text-green-700 font-bold hover:underline">My Tickets</button>
          </div>
          <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-6 shadow flex flex-col items-center">
            <i class="fa fa-book text-yellow-600 text-3xl mb-2"></i>
            <div class="font-bold text-blue-900 mb-1">Resources</div>
            <p class="text-sm text-gray-600 mb-2 text-center">Explore study guides, devotionals, and recommended readings.</p>
            <button onclick="showResources()" class="text-yellow-700 font-bold hover:underline">Browse Resources</button>
          </div>
        </div>

        <!-- Support Tickets Section -->
        <div id="support-tickets-section" class="hidden">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-blue-900">My Support Tickets</h3>
            <button id="new-ticket-btn" class="btn-gold px-4 py-2 rounded-lg font-semibold">
              <i class="fa fa-plus mr-2"></i>New Ticket
            </button>
          </div>
          
          <div id="user-tickets-list" class="space-y-4">
            <!-- Tickets will be loaded here -->
          </div>
        </div>

        <!-- New Ticket Form -->
        <div id="new-ticket-form" class="hidden bg-gray-50 rounded-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-blue-900 mb-4">Create New Support Ticket</h3>
          <form id="support-ticket-form" class="space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Subject</label>
                <input type="text" id="ticket-subject" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gold focus:outline-none" placeholder="Brief description of your issue" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Priority</label>
                <select id="ticket-priority" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gold focus:outline-none">
                  <option value="Low">Low</option>
                  <option value="Medium" selected>Medium</option>
                  <option value="High">High</option>
                  <option value="Urgent">Urgent</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Description</label>
              <textarea id="ticket-description" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gold focus:outline-none" rows="4" placeholder="Please describe your issue in detail..." required></textarea>
            </div>
            <div class="flex gap-3">
              <button type="submit" class="btn-gold px-6 py-2 rounded-lg font-semibold">
                <i class="fa fa-paper-plane mr-2"></i>Submit Ticket
              </button>
              <button type="button" id="cancel-ticket-btn" class="px-6 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">
                Cancel
              </button>
            </div>
          </form>
        </div>

        <!-- FAQs Section -->
        <div id="faqs-section" class="hidden">
          <h3 class="text-xl font-bold text-blue-900 mb-4">Frequently Asked Questions</h3>
          <div class="space-y-4">
            <div class="bg-white rounded-lg p-4 shadow">
              <h4 class="font-semibold text-blue-900 mb-2">How do I access my lessons?</h4>
              <p class="text-gray-700">Click on the "My Lessons" section in your dashboard. You can start with Day 1 and progress through each lesson at your own pace.</p>
            </div>
            <div class="bg-white rounded-lg p-4 shadow">
              <h4 class="font-semibold text-blue-900 mb-2">How do I track my progress?</h4>
              <p class="text-gray-700">Your progress is automatically tracked as you complete lessons and quizzes. You can view your progress in the "Progress" section.</p>
            </div>
            <div class="bg-white rounded-lg p-4 shadow">
              <h4 class="font-semibold text-blue-900 mb-2">When will I receive my certificate?</h4>
              <p class="text-gray-700">Certificates are automatically generated when you complete all lessons in a course. You can download them from the "Certificates" section.</p>
            </div>
            <div class="bg-white rounded-lg p-4 shadow">
              <h4 class="font-semibold text-blue-900 mb-2">Can I reset my progress?</h4>
              <p class="text-gray-700">Currently, progress cannot be reset. Please contact support if you need assistance with this.</p>
            </div>
          </div>
        </div>

        <!-- Resources Section -->
        <div id="resources-section" class="hidden">
          <h3 class="text-xl font-bold text-blue-900 mb-4">Study Resources</h3>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg p-6 shadow">
              <h4 class="font-semibold text-blue-900 mb-2">Study Guides</h4>
              <ul class="text-gray-700 space-y-2">
                <li>‚Ä¢ Daily Devotional Guide</li>
                <li>‚Ä¢ Bible Study Methods</li>
                <li>‚Ä¢ Prayer Journal Template</li>
                <li>‚Ä¢ Scripture Memory Cards</li>
              </ul>
            </div>
            <div class="bg-white rounded-lg p-6 shadow">
              <h4 class="font-semibold text-blue-900 mb-2">Recommended Reading</h4>
              <ul class="text-gray-700 space-y-2">
                <li>‚Ä¢ "Mere Christianity" by C.S. Lewis</li>
                <li>‚Ä¢ "The Purpose Driven Life" by Rick Warren</li>
                <li>‚Ä¢ "Knowing God" by J.I. Packer</li>
                <li>‚Ä¢ "The Cost of Discipleship" by Dietrich Bonhoeffer</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Support Ticket Modal -->
      <div id="ticket-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Support Ticket Details</h3>
            <button id="close-ticket-modal" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
          </div>
          <div id="ticket-detail-content">
            <!-- Ticket details will be loaded here -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modern Footer -->
  <footer class="bg-gradient-to-br from-[#2046B3] via-[#7C3AED] to-[#2046B3] text-white relative overflow-hidden">
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10">
      <svg class="w-full h-full" viewBox="0 0 1200 400" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="footer-pattern" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
            <circle cx="30" cy="30" r="2" fill="currentColor"/>
            <circle cx="15" cy="15" r="1" fill="currentColor"/>
            <circle cx="45" cy="45" r="1" fill="currentColor"/>
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#footer-pattern)"/>
      </svg>
    </div>
    
    <div class="relative z-10 max-w-7xl mx-auto px-4 py-16">
      <!-- Main Footer Content -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
        
        <!-- Ministry Info -->
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <img src="assets/images/WhatsApp Image 2025-07-04 at 17.27.34_37ced412.jpg" alt="Hearts After God Ministry Logo" class="h-16 w-16 rounded-full border-4 border-[#FDBA17] shadow-lg" />
            <div>
              <h3 class="text-xl font-bold text-[#FDBA17]">Hearts After God</h3>
              <p class="text-sm text-white/80">Ministry</p>
            </div>
          </div>
          <p class="text-white/90 leading-relaxed">
            Empowering believers worldwide through discipleship, soul-winning, and revival. Join our global family as we reach the world for Christ.
          </p>
          <div class="flex gap-3">
            <a href="https://chat.whatsapp.com/Cyjm2DDg5Gi08QHDW6Uw5p?mode=r_t" target="_blank" class="p-2 bg-green-500 rounded-full hover:bg-green-600 transition-colors" aria-label="WhatsApp">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/></svg>
            </a>
            <a href="https://www.instagram.com/heartsaftergodministry/" target="_blank" class="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full hover:from-purple-600 hover:to-pink-600 transition-colors" aria-label="Instagram">
              <svg class="w-5 h-5" viewBox="0 0 448 512" fill="currentColor"><path d="M224,202.66A53.34,53.34,0,1,0,277.34,256,53.38,53.38,0,0,0,224,202.66Zm124.71-41a54,54,0,0,0-30.36-30.36C293.19,120,256,118.13,224,118.13s-69.19,1.87-94.35,13.17a54,54,0,0,0-30.36,30.36C120,162.81,118.13,200,118.13,232s1.87,69.19,13.17,94.35a54,54,0,0,0,30.36,30.36C162.81,392,200,393.87,232,393.87s69.19-1.87,94.35-13.17a54,54,0,0,0,30.36-30.36C392,349.19,393.87,312,393.87,280S392,162.81,348.71,161.66ZM224,338.66A82.66,82.66,0,1,1,306.66,256,82.75,82.75,0,0,1,224,338.66Zm85.4-148.13a19.2,19.2,0,1,1-19.2-19.2A19.2,19.2,0,0,1,309.4,190.53ZM398.8,80.13A54.13,54.13,0,0,0,368.13,49.46C349.19,32,312,30.13,280,30.13s-69.19,1.87-94.35,13.17A54.13,54.13,0,0,0,49.46,80.13C32,99.07,30.13,136.26,30.13,168.26s1.87,69.19,13.17,94.35A54.13,54.13,0,0,0,80.13,398.8C99.07,416.24,136.26,418.13,168.26,418.13s69.19-1.87,94.35-13.17a54,54,0,0,0,30.36-30.36C416.24,349.19,418.13,312,418.13,280S416.24,162.81,398.8,80.13ZM224,338.66A82.66,82.66,0,1,1,306.66,256,82.75,82.75,0,0,1,224,338.66Zm85.4-148.13a19.2,19.2,0,1,1-19.2-19.2A19.2,19.2,0,0,1,309.4,190.53Z"/></svg>
            </a>
            <a href="https://t.me/+ZnRxd1gF7AcwMzY0" target="_blank" class="p-2 bg-blue-400 rounded-full hover:bg-blue-500 transition-colors" aria-label="Telegram">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9.04 16.56l-.39 3.67c.56 0 .8-.24 1.09-.53l2.62-2.5 5.44 3.98c1 .55 1.72.26 1.97-.92l3.58-16.76c.32-1.48-.54-2.06-1.5-1.7L2.18 9.13c-1.45.56-1.43 1.36-.25 1.72l4.59 1.43 10.65-6.7c.5-.32.96-.14.58.18z"/></svg>
            </a>
            <a href="https://www.facebook.com/share/g/16NwpW8sCB/" target="_blank" class="p-2 bg-blue-600 rounded-full hover:bg-blue-700 transition-colors" aria-label="Facebook">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
            <a href="https://www.youtube.com/@HeartsAfterGodMinistries" target="_blank" class="p-2 bg-red-600 rounded-full hover:bg-red-700 transition-colors" aria-label="YouTube">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
            </a>
            <a href="https://www.tiktok.com/@heartsaftergodmin7?_t=ZM-8x9VO2On7B7&_r=1" target="_blank" class="p-2 bg-black rounded-full hover:bg-gray-800 transition-colors" aria-label="TikTok">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#000"/><path d="M22 13.5c-.5 0-1-.1-1.5-.3v4.3c0 2.2-1.8 4-4 4s-4-1.8-4-4 1.8-4 4-4c.2 0 .4 0 .6.1v2.1c-.2-.1-.4-.1-.6-.1-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2v-7.5h2c0 1.1.9 2 2 2v1.5z" fill="#fff"/></svg>
            </a>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="space-y-4">
          <h4 class="text-lg font-bold text-[#FDBA17] border-b-2 border-[#FDBA17] pb-2">Quick Links</h4>
          <ul class="space-y-2">
            <li><a href="about.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>About Us</a></li>
            <li><a href="vision.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Our Vision</a></li>
            <li><a href="events.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Events</a></li>
            <li><a href="sermons.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Sermons</a></li>
            <li><a href="blog.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Blog</a></li>
            <li><a href="gallery.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Gallery</a></li>
          </ul>
        </div>

        <!-- Ministries -->
        <div class="space-y-4">
          <h4 class="text-lg font-bold text-[#FDBA17] border-b-2 border-[#FDBA17] pb-2">Ministries</h4>
          <ul class="space-y-2">
            <li><a href="discipleship.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Discipleship</a></li>
            <li><a href="missions.html" class="text-white/80 hover:text-[#FDBA17] transition-colors flex items-center gap-2"><span class="w-1 h-1 bg-[#FDBA17] rounded-full"></span>Missions</a></li>
          </ul>
        </div>

        <!-- Contact & Newsletter -->
        <div class="space-y-4">
          <h4 class="text-lg font-bold text-[#FDBA17] border-b-2 border-[#FDBA17] pb-2">Stay Connected</h4>
          <div class="space-y-3">
            <div class="flex items-center gap-3 text-white/80">
              <svg class="w-5 h-5 text-[#FDBA17]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span class="text-sm">info@heartsaftergod.org</span>
            </div>
            <div class="flex items-center gap-3 text-white/80">
              <svg class="w-5 h-5 text-[#FDBA17]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span class="text-sm">+1 (555) 123-4567</span>
            </div>
            <div class="flex items-center gap-3 text-white/80">
              <svg class="w-5 h-5 text-[#FDBA17]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span class="text-sm">Global Ministry</span>
            </div>
          </div>
          
          <!-- Newsletter Signup -->
          <div class="mt-6">
            <h5 class="text-sm font-semibold text-white mb-2">Newsletter</h5>
            <form class="flex gap-2">
              <input type="email" placeholder="Your email" class="flex-1 px-3 py-2 text-sm bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:border-[#FDBA17] transition-colors">
              <button type="submit" class="px-4 py-2 bg-[#FDBA17] text-[#2046B3] text-sm font-semibold rounded-lg hover:bg-[#e0a615] transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Bottom Bar -->
      <div class="border-t border-white/20 pt-8">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="text-sm text-white/70">
            &copy; 2025 Hearts After God Ministry. All rights reserved. | Empowering Believers. Winning Souls.
          </div>
          <div class="flex gap-6 text-sm">
            <a href="#" class="text-white/70 hover:text-[#FDBA17] transition-colors">Privacy Policy</a>
            <a href="#" class="text-white/70 hover:text-[#FDBA17] transition-colors">Terms of Service</a>
            <a href="#" class="text-white/70 hover:text-[#FDBA17] transition-colors">Donate</a>
            <a href="contact.html" class="text-white/70 hover:text-[#FDBA17] transition-colors">Contact</a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Profile Modal -->
  <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative">
      <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold text-blue-900 mb-4">My Profile</h2>
      <div class="flex flex-col items-center gap-4">
        <div id="profile-cover" class="w-full h-24 rounded-lg bg-gray-200 flex items-center justify-center mb-2 relative overflow-hidden">
          <canvas id="profile-cover-cropper" width="320" height="96" class="absolute top-0 left-0 w-full h-full z-10 hidden"></canvas>
          <img id="profile-cover-img" src="" alt="Cover" class="w-full h-full object-cover hidden" />
          <span id="profile-cover-placeholder" class="text-gray-400">No cover image</span>
          <input type="file" id="profile-cover-upload" accept="image/*" class="absolute top-2 right-2 opacity-0 w-8 h-8 cursor-pointer" title="Upload cover" />
          <button id="profile-cover-upload-btn" class="absolute top-2 right-2 bg-gold text-white px-2 py-1 rounded text-xs">Upload</button>
          <div id="profile-cover-crop-controls" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2 z-20 hidden">
            <button id="crop-zoom-in" class="bg-blue-600 text-white px-2 py-1 rounded">+</button>
            <button id="crop-zoom-out" class="bg-blue-600 text-white px-2 py-1 rounded">-</button>
            <button id="crop-aspect" class="bg-blue-600 text-white px-2 py-1 rounded">Lock 4:1</button>
            <button id="crop-save" class="bg-gold text-white px-2 py-1 rounded">Save Crop</button>
          </div>
          <div id="profile-cover-preview" class="absolute top-2 left-2 w-24 h-6 rounded border-2 border-gold bg-white/80 z-30 flex items-center justify-center overflow-hidden hidden"></div>
        </div>
        <div id="profile-avatar" class="text-5xl"></div>
        <select id="profile-avatar-select" class="mb-2 px-2 py-1 border rounded">
          <option value="üßë‚Äçü¶±">üßë‚Äçü¶±</option><option value="üßëüèæ">üßëüèæ</option><option value="üë©‚Äçü¶∞">üë©‚Äçü¶∞</option><option value="üßë">üßë</option><option value="üë®‚Äçü¶≥">üë®‚Äçü¶≥</option><option value="üë©üèΩ">üë©üèΩ</option><option value="üßëüèª">üßëüèª</option><option value="üë©‚Äçü¶≥">üë©‚Äçü¶≥</option>
        </select>
        <input id="profile-name" class="px-2 py-1 border rounded w-full" />
        <input id="profile-email" class="px-2 py-1 border rounded w-full" disabled />
        <div id="profile-badges" class="flex flex-wrap gap-2 mt-2"></div>
        <div id="profile-ban-history" class="w-full mt-2 text-xs text-red-700"></div>
        <div id="profile-mute-history" class="w-full mt-1 text-xs text-yellow-700"></div>
        <button id="profile-save-btn" class="bg-blue-600 text-white px-4 py-2 rounded font-bold mt-4">Save Changes</button>
      </div>
    </div>
  </div>
  <!-- Admin Broadcast Modal -->
  <div id="broadcast-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative">
      <button onclick="document.getElementById('broadcast-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold text-purple-700 mb-4">Send Broadcast Message</h2>
      <textarea id="broadcast-input" class="w-full border rounded p-2 mb-4" rows="3" placeholder="Type your message..."></textarea>
      <button id="broadcast-send-btn" class="bg-gold text-white px-4 py-2 rounded font-bold">Send</button>
    </div>
  </div>
  <div id="broadcast-banner" class="hidden fixed top-0 left-0 w-full bg-purple-700 text-white text-center py-2 z-50 font-bold"></div>

  <!-- Enhanced Moderation Modals -->
  
  <!-- User Moderation Modal -->
  <div id="user-moderation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 id="user-moderation-modal-title" class="text-xl font-bold mb-4">Moderate User</h3>
      <div id="user-moderation-modal-body" class="mb-4">
        <!-- Populated by JS -->
      </div>
      <form id="user-moderation-form" class="space-y-3">
        <div>
          <label class="block font-semibold">Action</label>
          <select id="moderation-action-select" class="border px-2 py-1 rounded w-full">
            <option value="ban">Ban</option>
            <option value="mute">Mute</option>
            <option value="unban">Unban</option>
            <option value="unmute">Unmute</option>
            <option value="warn">Warn</option>
          </select>
        </div>
        <div id="moderation-duration-group">
          <label class="block font-semibold">Duration</label>
          <select id="moderation-duration-select" class="border px-2 py-1 rounded w-full">
            <option value="3600">1 hour</option>
            <option value="86400">24 hours</option>
            <option value="604800">7 days</option>
            <option value="2592000">30 days</option>
            <option value="0">Permanent</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold">Reason</label>
          <textarea id="moderation-reason-input" class="border px-2 py-1 rounded w-full" rows="3" placeholder="Enter moderation reason..." required></textarea>
        </div>
        <div class="flex gap-2 mt-4">
          <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Submit</button>
          <button type="button" id="user-moderation-modal-cancel" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Content Moderation Modal -->
  <div id="content-moderation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
      <h3 id="content-moderation-modal-title" class="text-xl font-bold mb-4">Moderate Content</h3>
      <div id="content-moderation-modal-body" class="mb-4">
        <!-- Populated by JS -->
      </div>
      <form id="content-moderation-form" class="space-y-3">
        <div>
          <label class="block font-semibold">Action</label>
          <select id="content-action-select" class="border px-2 py-1 rounded w-full">
            <option value="approve">Approve</option>
            <option value="reject">Reject</option>
            <option value="delete">Delete</option>
            <option value="edit">Edit</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold">Reason (Optional)</label>
          <textarea id="content-reason-input" class="border px-2 py-1 rounded w-full" rows="3" placeholder="Enter reason for action..."></textarea>
        </div>
        <div class="flex gap-2 mt-4">
          <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Submit</button>
          <button type="button" id="content-moderation-modal-cancel" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Moderation Logs Modal -->
  <div id="modlogs-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8 relative">
      <button onclick="document.getElementById('modlogs-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
      <h2 class="text-2xl font-bold text-purple-700 mb-4">Moderation Logs</h2>
      <table class="w-full text-sm"><thead><tr class="bg-purple-50"><th class="py-2 px-3 text-left">User</th><th class="py-2 px-3 text-left">Action</th><th class="py-2 px-3 text-left">Date</th><th class="py-2 px-3 text-left">Duration</th></tr></thead><tbody id="modlogs-table"></tbody></table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="assets/js/discipleship-backend.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    // Set user name/email from localStorage if available
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const user = JSON.parse(localStorage.getItem('discipleship_logged_in_user'));
        if (user && user.name) {
          document.getElementById('user-name').innerText = user.name;
          document.getElementById('nav-user-name').innerText = user.name;
        }
        if (user && user.email) {
          document.getElementById('user-email').innerText = user.email;
          document.getElementById('user-avatar').innerText = user.name ? user.name[0].toUpperCase() : 'üë§';
          document.getElementById('nav-user-avatar').innerText = user.name ? user.name[0].toUpperCase() : 'üë§';
        }
      } catch (e) {}
      document.getElementById('logout-btn').onclick = function() {
        window.location.href = 'discipleship-login.html';
      };
      // Rotating motivational quotes/verses
      const quotes = [
        '"But you will receive power when the Holy Spirit comes on you; and you will be my witnesses..." ‚Äî Acts 1:8',
        '"I can do all things through Christ who strengthens me." ‚Äî Philippians 4:13',
        '"Let your light shine before others." ‚Äî Matthew 5:16',
        '"The Lord is my shepherd; I shall not want." ‚Äî Psalm 23:1',
        '"Be strong and courageous. Do not be afraid." ‚Äî Joshua 1:9'
      ];
      let idx = 0;
      setInterval(() => {
        idx = (idx + 1) % quotes.length;
        document.getElementById('motivation-text').innerText = quotes[idx];
      }, 7000);
      // Link lesson progress, badges, and stats from backend
      const backend = new window.DiscipleshipBackend();
      const user = getCurrentUser();
      let userId = null;
      if (user) {
        for (const [id, u] of Object.entries(backend.users)) {
          if (u.email === user.email) { userId = id; break; }
        }
        if (userId) {
          const progress = backend.getUserProgress(userId);
          const stats = backend.getUserStats(userId);
          // Update dashboard widgets
          document.getElementById('summary-lessons').innerText = stats.completedLessons;
          document.getElementById('summary-progress').innerText = stats.progressPercentage + '%';
          document.getElementById('summary-badges').innerText = progress.certificates.length;
          // Update next lesson
          const nextLessonNum = progress.completedLessons.length + 1;
          document.getElementById('next-lesson-title').innerText = 'Day ' + nextLessonNum + ': ' + (window.lessons && window.lessons[nextLessonNum-1] ? window.lessons[nextLessonNum-1].title : 'Next Lesson');
          // Update recent activity
          const recent = [];
          progress.completedLessons.slice(-3).reverse().forEach(lessonId => {
            recent.push('‚úîÔ∏è Completed Day ' + lessonId);
          });
          if (progress.certificates.length) {
            recent.push('üèÜ Earned badge: ' + progress.certificates[progress.certificates.length-1].name);
          }
          document.getElementById('recent-activity').innerHTML = recent.map(r => `<li>${r}</li>`).join('');
          // Update lesson cards (status)
          document.querySelectorAll('#lessons .group').forEach((card, idx) => {
            const lessonId = idx+1;
            const statusSpan = card.querySelector('span.bg-yellow-500, span.bg-blue-500, span.bg-purple-500, span.bg-red-500');
            if (progress.completedLessons.includes(lessonId)) {
              statusSpan.innerText = 'Completed';
              statusSpan.className = 'bg-yellow-500 text-blue-900 text-xs px-3 py-1 rounded-full font-bold shadow-sm';
            } else if (lessonId === nextLessonNum) {
              statusSpan.innerText = 'In Progress';
              statusSpan.className = 'bg-blue-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm';
            } else if (lessonId < nextLessonNum) {
              statusSpan.innerText = 'Review';
              statusSpan.className = 'bg-yellow-500 text-blue-900 text-xs px-3 py-1 rounded-full font-bold shadow-sm';
            } else {
              statusSpan.innerText = 'Locked';
              statusSpan.className = (lessonId%2===0 ? 'bg-purple-500' : 'bg-red-500') + ' text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm';
            }
          });
          // Advanced badge logic
          const badges = [];
          if (progress.completedLessons.length >= 1) {
            badges.push({
              icon: 'fa-star',
              color: 'yellow-500',
              name: 'First Steps',
              desc: 'Completed your first lesson',
              unlocked: true
            });
          }
          if (progress.completedLessons.length >= 2 && stats.currentStreak >= 2) {
            badges.push({
              icon: 'fa-bolt',
              color: 'purple-500',
              name: 'Quick Learner',
              desc: 'Completed 2 lessons in a row',
              unlocked: true
            });
          }
          if (Object.keys(progress.quizScores).length && Object.values(progress.quizScores).some(q => q.score >= 90)) {
            badges.push({
              icon: 'fa-trophy',
              color: 'blue-500',
              name: 'Quiz Master',
              desc: 'Scored 90%+ on a quiz',
              unlocked: true
            });
          }
          if (Object.keys(progress.notes).length) {
            badges.push({
              icon: 'fa-book',
              color: 'green-500',
              name: 'Note Taker',
              desc: 'Saved a lesson note',
              unlocked: true
            });
          }
          // New badge: Streak Champion
          if (stats.currentStreak >= 3) {
            badges.push({
              icon: 'fa-fire',
              color: 'red-500',
              name: 'Streak Champion',
              desc: '3+ day learning streak',
              unlocked: true
            });
          }
          // New badge: Time Investor
          const totalTime = Object.values(progress.timeSpent).reduce((a,b)=>a+b,0);
          if (totalTime >= 120) {
            badges.push({
              icon: 'fa-hourglass-half',
              color: 'gold-500',
              name: 'Time Investor',
              desc: 'Spent 2+ hours learning',
              unlocked: true
            });
          }
          // New badge: Community Builder (simulate with progress.joinedCommunity)
          if (progress.joinedCommunity) {
            badges.push({
              icon: 'fa-users',
              color: 'blue-500',
              name: 'Community Builder',
              desc: 'Joined a study group',
              unlocked: true
            });
          }
          // Render badges
          const badgeList = document.querySelector('#achievements .flex.flex-wrap');
          if (badgeList) {
            badgeList.innerHTML = badges.map(badge => `
              <div class="flex flex-col items-center bg-gradient-to-br from-${badge.color.replace('-500','-100')} to-${badge.color.replace('-500','-200')} rounded-xl p-6 shadow w-48 relative group">
                <i class="fa ${badge.icon} text-${badge.color} text-3xl mb-2"></i>
                <div class="font-bold text-blue-900">${badge.name}</div>
                <div class="text-xs text-gray-600 mb-2">${badge.desc}</div>
                <div class="text-xs text-${badge.color} font-bold">Unlocked</div>
                <div class="absolute left-1/2 -translate-x-1/2 bottom-2 w-10/12 h-2 bg-${badge.color.replace('-500','-200')} rounded-full overflow-hidden">
                  <div class="bg-${badge.color} h-2 rounded-full" style="width:100%"></div>
                </div>
                <div class="absolute top-2 right-2 bg-${badge.color} text-white text-xs px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition">Unlocked!</div>
              </div>
            `).join('');
          }
          // Enhance lesson modal to show quiz scores, notes, and allow adding notes
          window.showLessonModal = function(id) {
            const lesson = window.lessons ? window.lessons.find(l => l.id === id) : null;
            let quizScore = progress.quizScores[id] ? progress.quizScores[id].score + '%' : 'N/A';
            let quizPassed = progress.quizScores[id] ? progress.quizScores[id].passed : false;
            let notes = backend.getUserNotes(userId, id);
            let checklistHtml = lesson && lesson.checklist ? lesson.checklist.map((item, idx) => `
              <li class="flex items-center gap-2 mb-2">
                <input type="checkbox" ${item.done ? 'checked' : ''} disabled class="form-checkbox h-5 w-5 text-blue-600 rounded" />
                <span class="${item.done ? 'line-through text-gray-400' : ''}">${item.text}</span>
              </li>
            `).join('') : '';
            const isCompleted = progress.completedLessons.includes(id);
            document.getElementById('lesson-modal-content').innerHTML = `
              <div id="lesson-success-msg" class="hidden mb-4 p-3 rounded bg-green-100 text-green-800 font-semibold flex items-center gap-2"><i class="fa fa-check-circle"></i> Lesson marked as complete!</div>
              <h2 class="text-xl font-bold text-blue-900 mb-2">${lesson ? lesson.title : 'Lesson ' + id}</h2>
              <div class="text-sm text-gray-600 mb-4">${lesson ? lesson.description : ''}</div>
              <div class="flex items-center gap-4 mb-4">
                <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-semibold">${lesson ? lesson.status : ''}</span>
                <span class="flex items-center gap-1 text-xs text-gray-600"><i class='fa fa-clipboard-check'></i> Quiz: ${quizScore} ${quizPassed ? '<span class=\'text-green-600\'>(Passed)</span>' : ''}</span>
              </div>
              <div class="mb-4">
                <h3 class="font-bold text-blue-900 mb-2">Checklist</h3>
                <ul>${checklistHtml}</ul>
              </div>
              <div class="mb-4">
                <h3 class="font-bold text-blue-900 mb-2">Your Notes</h3>
                <ul id="lesson-notes-list">${notes && notes.length ? notes.map(n => `<li class='mb-1 text-sm text-gray-700'>üìù ${n.content} <span class='text-xs text-gray-400'>(${n.date.split('T')[0]})</span></li>`).join('') : '<li class="text-gray-400">No notes yet.</li>'}</ul>
                <form id="add-note-form" class="mt-2 flex gap-2"> <input type="text" id="add-note-input" class="flex-1 px-2 py-1 border rounded" placeholder="Add a note..." required /> <button type="submit" class="bg-gold text-white px-3 py-1 rounded font-bold">Add</button> </form>
              </div>
              <button id="mark-complete-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition text-sm" ${isCompleted ? 'disabled' : ''}>${isCompleted ? 'Completed' : 'Mark as Complete'}</button>
            `;
            document.getElementById('lesson-modal').classList.remove('hidden');
            // Add note form logic
            const addNoteForm = document.getElementById('add-note-form');
            if (addNoteForm) {
              addNoteForm.onsubmit = function(e) {
                e.preventDefault();
                const noteVal = document.getElementById('add-note-input').value.trim();
                if (noteVal) {
                  backend.saveUserNote(userId, id, noteVal);
                  // Refresh notes list
                  const updatedNotes = backend.getUserNotes(userId, id);
                  document.getElementById('lesson-notes-list').innerHTML = updatedNotes.map(n => `<li class='mb-1 text-sm text-gray-700'>üìù ${n.content} <span class='text-xs text-gray-400'>(${n.date.split('T')[0]})</span></li>`).join('');
                  document.getElementById('add-note-input').value = '';
                }
              };
            }
            // Mark as complete logic
            const markBtn = document.getElementById('mark-complete-btn');
            if (markBtn && !isCompleted) {
              markBtn.onclick = function() {
                if (confirm('Are you sure you want to mark this lesson as complete?')) {
                  backend.completeLesson(userId, id);
                  // Show success message
                  const msg = document.getElementById('lesson-success-msg');
                  if (msg) { msg.classList.remove('hidden'); }
                  setTimeout(() => { window.location.reload(); }, 1200);
                }
              };
            }
          };
          // Community join simulation
          const joinBtn = document.getElementById('join-community-btn');
          const commExpanded = document.getElementById('community-expanded');
          if (joinBtn) {
            // Show expanded features if already joined
            if (progress.joinedCommunity) {
              joinBtn.disabled = true;
              joinBtn.innerText = 'Joined!';
              if (commExpanded) commExpanded.classList.remove('hidden');
              renderCommunityFeatures();
            }
            joinBtn.onclick = function() {
              if (confirm('Join the Hearts After God Study Group?')) {
                progress.joinedCommunity = true;
                backend.updateUserProgress(userId, progress);
                joinBtn.disabled = true;
                joinBtn.innerText = 'Joined!';
                if (commExpanded) commExpanded.classList.remove('hidden');
                renderCommunityFeatures();
                // Show success message and mock group
                const commSection = joinBtn.closest('section');
                if (commSection) {
                  const msg = document.createElement('div');
                  msg.className = 'mt-4 p-3 rounded bg-green-100 text-green-800 font-semibold flex items-center gap-2';
                  msg.innerHTML = '<i class="fa fa-users"></i> Welcome to the Study Group!';
                  commSection.appendChild(msg);
                  setTimeout(() => { msg.remove(); }, 2000);
                }
              }
            };
          }
          // Community features logic
          function renderCommunityFeatures() {
            // Announcements: admin can pin, all see, admin can remove
            const annKey = 'community_announcements';
            function getAnns() { return JSON.parse(localStorage.getItem(annKey)||'[]'); }
            function setAnns(anns) { localStorage.setItem(annKey, JSON.stringify(anns)); }
            const anns = getAnns();
            const annList = document.getElementById('community-announcements');
            const user = getCurrentUser();
            const isAdmin = user && user.role === 'admin';
            if (annList) {
              annList.innerHTML = (anns.length ? anns.map((a,i) => `<li>${a} ${isAdmin?`<button class='ml-2 text-red-500' onclick='removeAnnouncement(${i})' title='Remove'>&times;</button>`:''}</li>`): [
                '<li><span class="font-bold text-gold">[New]</span> Welcome to the Hearts After God Study Group! üéâ</li>',
                '<li>Next group devotional: <span class="font-semibold">Friday, 7pm</span> (Zoom link in chat)</li>',
                '<li>Share your testimony in the chat below!</li>'
              ]).join('');
            }
            window.removeAnnouncement = function(idx) {
              const anns = getAnns();
              anns.splice(idx,1);
              setAnns(anns);
              renderCommunityFeatures();
            };
            // Show pin form for admin
            const annForm = document.getElementById('announcement-form');
            if (annForm) {
              annForm.classList.toggle('hidden', !isAdmin);
              annForm.onsubmit = function(e) {
                e.preventDefault();
                const val = document.getElementById('announcement-input').value.trim();
                if (val) {
                  const anns = getAnns();
                  anns.unshift(`<span class='font-bold text-gold'>[Pinned]</span> ${val}`);
                  setAnns(anns);
                  renderCommunityFeatures();
                  document.getElementById('announcement-input').value = '';
                }
              };
            }
            // Leaderboard: aggregate all users, admin can promote
            const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
            const progress = JSON.parse(localStorage.getItem('discipleship_progress')||'{}');
            const avatars = ['üßë‚Äçü¶±','üßëüèæ','üë©‚Äçü¶∞','üßë','üë®‚Äçü¶≥','üë©üèΩ','üßëüèª','üë©‚Äçü¶≥'];
            const leaderboard = users.map((u,i)=>{
              const p = Object.values(progress).find(pr=>pr && pr.completedLessons && pr.notes && u.id && pr.userId ? pr.userId===u.id : u.email===user.email);
              return {
                name: u.name,
                email: u.email,
                lessons: p && p.completedLessons ? p.completedLessons.length : 0,
                badges: p && p.certificates ? p.certificates.length : 0,
                avatar: u.avatar || avatars[i%avatars.length],
                isCurrent: u.email===user.email,
                isAdmin: u.role==='admin',
                idx: i
              };
            });
            leaderboard.sort((a,b)=>b.lessons-a.lessons);
            const maxLessons = leaderboard.length ? leaderboard[0].lessons : 0;
            const tbody = document.getElementById('community-leaderboard');
            if (tbody) {
              tbody.innerHTML = leaderboard.map(m => `<tr${m.isCurrent ? ' class=\"bg-yellow-50 font-bold\"' : ''}><td class='py-1 px-3 text-2xl'>${m.avatar}</td><td class='py-1 px-3'>${m.name}</td><td class='py-1 px-3'>${m.lessons}</td><td class='py-1 px-3'>${m.badges}</td><td>${m.lessons===maxLessons&&m.lessons>0?'<span class=\"inline-block bg-gold text-white text-xs px-2 py-0.5 rounded-full\">Top Learner</span>':''}</td><td>${isAdmin&&!m.isAdmin?`<button class='text-blue-600 underline' onclick='promoteAdmin(${m.idx})'>Promote</button> <button class='text-red-600 underline' onclick='banUser(${m.idx},true)'>Ban</button> <button class='text-yellow-600 underline' onclick='muteUser(${m.idx},true)'>Mute</button>`:m.isAdmin?'<span class=\"text-purple-600 font-bold\">Admin</span>':''}${m.banned?`<span class=\"text-red-600 font-bold ml-2\">Banned</span> ${isAdmin?`<button class='text-green-600 underline' onclick='unbanUser(${m.idx})'>Unban</button>`:''}`:''}${m.muted?`<span class=\"text-yellow-600 font-bold ml-2\">Muted</span> ${isAdmin?`<button class='text-green-600 underline' onclick='unmuteUser(${m.idx})'>Unmute</button>`:''}`:''}</td></tr>`).join('');
            }
            window.promoteAdmin = function(idx) {
              const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
              users[idx].role = 'admin';
              localStorage.setItem('discipleship_users', JSON.stringify(users));
              renderCommunityFeatures();
            };
            // Timed mutes/bans
            window.banUser = function(idx, timed) {
              const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
              users[idx].banned = true;
              let duration = 'permanent';
              if (timed) {
                const mins = prompt('Ban for how many minutes? (Leave blank for permanent)');
                if (mins && !isNaN(mins)) {
                  users[idx].banUntil = Date.now() + parseInt(mins)*60000;
                  users[idx].banHistory = (users[idx].banHistory||[]).concat({date:new Date().toISOString(),duration:mins+' min'});
                  duration = mins+' min';
                } else {
                  users[idx].banUntil = null;
                  users[idx].banHistory = (users[idx].banHistory||[]).concat({date:new Date().toISOString(),duration:'permanent'});
                }
              }
              addModLog(users[idx].name,'Ban',duration);
              localStorage.setItem('discipleship_users', JSON.stringify(users));
              renderCommunityFeatures();
            };
            window.muteUser = function(idx, timed) {
              const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
              users[idx].muted = true;
              let duration = 'permanent';
              if (timed) {
                const mins = prompt('Mute for how many minutes? (Leave blank for permanent)');
                if (mins && !isNaN(mins)) {
                  users[idx].muteUntil = Date.now() + parseInt(mins)*60000;
                  users[idx].muteHistory = (users[idx].muteHistory||[]).concat({date:new Date().toISOString(),duration:mins+' min'});
                  duration = mins+' min';
                } else {
                  users[idx].muteUntil = null;
                  users[idx].muteHistory = (users[idx].muteHistory||[]).concat({date:new Date().toISOString(),duration:'permanent'});
                }
              }
              addModLog(users[idx].name,'Mute',duration);
              localStorage.setItem('discipleship_users', JSON.stringify(users));
              renderCommunityFeatures();
            };
            // Auto-unban/unmute
            setInterval(()=>{
              const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
              let changed = false;
              users.forEach(u=>{
                if (u.banned && u.banUntil && Date.now()>u.banUntil) { u.banned=false; u.banUntil=null; changed=true; }
                if (u.muted && u.muteUntil && Date.now()>u.muteUntil) { u.muted=false; u.muteUntil=null; changed=true; }
              });
              if (changed) localStorage.setItem('discipleship_users', JSON.stringify(users));
            }, 5000);
            window.unbanUser = function(idx) {
              const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
              users[idx].banned = false;
              addModLog(users[idx].name,'Unban','');
              localStorage.setItem('discipleship_users', JSON.stringify(users));
              renderCommunityFeatures();
            };
            window.unmuteUser = function(idx) {
              const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
              users[idx].muted = false;
              addModLog(users[idx].name,'Unmute','');
              localStorage.setItem('discipleship_users', JSON.stringify(users));
              renderCommunityFeatures();
            };
            // Group chat: use localStorage for demo, poll every 2s, admin can delete, emoji reactions
            const chatKey = 'community_chat_messages';
            function getChat() { return JSON.parse(localStorage.getItem(chatKey)||'[]'); }
            function setChat(msgs) { localStorage.setItem(chatKey, JSON.stringify(msgs)); }
            function renderChat() {
              const msgs = getChat();
              const box = document.getElementById('community-chat-messages');
              if (box) {
                box.innerHTML = msgs.map((m,i) => `<div class='flex gap-2 items-center'><span class='font-bold text-blue-900'>${m.name}:</span> <span>${m.text}</span> <span class='flex gap-1'>${['üëç','‚ù§Ô∏è','üôè','üéâ'].map(e=>`<button class='text-lg' onclick='reactChat(${i},\"${e}\")' title='React'>${e}${m.reactions&&m.reactions[e]?`<span class=\\"text-xs\\">${m.reactions[e]}</span>`:''}</button>`).join('')}</span> ${isAdmin?`<button class='ml-2 text-red-500' onclick='deleteChat(${i})' title='Delete'>&times;</button>`:''}</div>`).join('');
                box.scrollTop = box.scrollHeight;
              }
            }
            // Chat restriction for muted users
            const usersArr = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
            const thisUser = usersArr.find(u=>u.email===user.email);
            const chatForm = document.getElementById('community-chat-form');
            if (chatForm) {
              if (thisUser && thisUser.muted) {
                chatForm.classList.add('opacity-50','pointer-events-none');
                if (!document.getElementById('muted-warning')) {
                  const warn = document.createElement('div');
                  warn.id = 'muted-warning';
                  warn.className = 'mb-2 text-yellow-700 font-bold flex items-center gap-2';
                  warn.innerHTML = '<i class="fa fa-ban"></i> You are muted and cannot send messages.';
                  chatForm.parentNode.insertBefore(warn, chatForm);
                }
              } else {
                chatForm.classList.remove('opacity-50','pointer-events-none');
                const warn = document.getElementById('muted-warning');
                if (warn) warn.remove();
              }
              chatForm.onsubmit = function(e) {
                if (thisUser && thisUser.muted) return false;
                e.preventDefault();
                const input = document.getElementById('community-chat-input');
                const val = input.value.trim();
                if (val) {
                  const msgs = getChat();
                  msgs.push({ name: user.name, text: val });
                  setChat(msgs);
                  renderChat();
                  input.value = '';
                }
              };
            }
            window.deleteChat = function(idx) {
              const msgs = getChat();
              msgs.splice(idx,1);
              setChat(msgs);
              renderChat();
            };
            window.reactChat = function(idx, emoji) {
              const msgs = getChat();
              msgs[idx].reactions = msgs[idx].reactions || {};
              msgs[idx].reactions[emoji] = (msgs[idx].reactions[emoji]||0)+1;
              setChat(msgs);
              renderChat();
            };
            renderChat();
            setInterval(renderChat, 2000);
            // Profile modal logic
            const profileBtn = document.getElementById('view-profile-btn');
            if (profileBtn) {
              profileBtn.onclick = function() {
                const users = JSON.parse(localStorage.getItem('discipleship_users')||'[]');
                const idx = users.findIndex(u=>u.email===user.email);
                const u = users[idx];
                document.getElementById('profile-modal').classList.remove('hidden');
                // Cover image
                if (u.cover) {
                  document.getElementById('profile-cover-img').src = u.cover;
                  document.getElementById('profile-cover-img').classList.remove('hidden');
                  document.getElementById('profile-cover-placeholder').classList.add('hidden');
                } else {
                  document.getElementById('profile-cover-img').classList.add('hidden');
                  document.getElementById('profile-cover-placeholder').classList.remove('hidden');
                }
                document.getElementById('profile-avatar').innerText = u.avatar || avatars[idx%avatars.length];
                document.getElementById('profile-avatar-select').value = u.avatar || avatars[idx%avatars.length];
                document.getElementById('profile-name').value = u.name;
                document.getElementById('profile-email').value = u.email;
                // Show badges
                const p = Object.values(progress).find(pr=>pr && pr.completedLessons && pr.notes && u.id && pr.userId ? pr.userId===u.id : u.email===user.email);
                const badgeBox = document.getElementById('profile-badges');
                badgeBox.innerHTML = (p && p.certificates ? p.certificates.map(b=>`<span class='inline-block bg-gold text-white text-xs px-2 py-0.5 rounded-full'>${b.name||'Badge'}</span>`).join('') : '');
                // Save changes
                document.getElementById('profile-save-btn').onclick = function() {
                  u.avatar = document.getElementById('profile-avatar-select').value;
                  u.name = document.getElementById('profile-name').value;
                  users[idx] = u;
                  localStorage.setItem('discipleship_users', JSON.stringify(users));
                  // Save cover
                  if (window._profileCoverDataUrl) {
                    u.cover = window._profileCoverDataUrl;
                    localStorage.setItem('discipleship_users', JSON.stringify(users));
                  }
                  document.getElementById('profile-modal').classList.add('hidden');
                  renderCommunityFeatures();
                };
                document.getElementById('profile-avatar-select').onchange = function() {
                  document.getElementById('profile-avatar').innerText = this.value;
                };
                // Cover upload
                document.getElementById('profile-cover-upload-btn').onclick = function() {
                  document.getElementById('profile-cover-upload').click();
                };
                document.getElementById('profile-cover-upload').onchange = function(e) {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                      // Center crop preview (simple, square)
                      const img = new window.Image();
                      img.onload = function() {
                        const size = Math.min(img.width, img.height);
                        const canvas = document.createElement('canvas');
                        canvas.width = canvas.height = 320;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, (img.width-size)/2, (img.height-size)/2, size, size, 0, 0, 320, 320);
                        window._profileCoverDataUrl = canvas.toDataURL('image/jpeg');
                        document.getElementById('profile-cover-img').src = window._profileCoverDataUrl;
                        document.getElementById('profile-cover-img').classList.remove('hidden');
                        document.getElementById('profile-cover-placeholder').classList.add('hidden');
                      };
                      img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                  }
                };
                // Ban/mute history
                document.getElementById('profile-ban-history').innerHTML = u.banHistory ? 'Ban history: ' + u.banHistory.map(b=>`${b.date.split('T')[0]} (${b.duration})`).join(', ') : '';
                document.getElementById('profile-mute-history').innerHTML = u.muteHistory ? 'Mute history: ' + u.muteHistory.map(b=>`${b.date.split('T')[0]} (${b.duration})`).join(', ') : '';
                // Advanced cropping
                document.getElementById('profile-cover-upload').onchange = function(e) {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                      const img = new window.Image();
                      img.onload = function() {
                        // Advanced crop: zoom/drag
                        const cropper = document.getElementById('profile-cover-cropper');
                        cropper.classList.remove('hidden');
                        document.getElementById('profile-cover-img').classList.add('hidden');
                        document.getElementById('profile-cover-placeholder').classList.add('hidden');
                        document.getElementById('profile-cover-crop-controls').classList.remove('hidden');
                        document.getElementById('profile-cover-preview').classList.remove('hidden');
                        let zoom = 1, offsetX = 0, offsetY = 0, dragging = false, dragStart = null, aspectLock = true;
                        function draw() {
                          const ctx = cropper.getContext('2d');
                          ctx.clearRect(0,0,320,96);
                          let w = img.width*zoom, h = img.height*zoom;
                          // Aspect ratio lock (4:1)
                          if (aspectLock) {
                            const targetRatio = 320/96;
                            if (w/h > targetRatio) { w = h*targetRatio; } else { h = w/targetRatio; }
                          }
                          ctx.drawImage(img, offsetX, offsetY, w, h);
                          // Live preview
                          const preview = document.getElementById('profile-cover-preview');
                          const pctx = preview.getContext('2d');
                          preview.width = 96*4; preview.height = 24;
                          pctx.clearRect(0,0,preview.width,preview.height);
                          pctx.drawImage(cropper, 0, 0, 320, 96, 0, 0, preview.width, preview.height);
                        }
                        draw();
                        cropper.onmousedown = function(e) { dragging=true; dragStart={x:e.offsetX, y:e.offsetY, ox:offsetX, oy:offsetY}; };
                        cropper.onmouseup = function(){dragging=false;};
                        cropper.onmouseleave = function(){dragging=false;};
                        cropper.onmousemove = function(e){
                          if (dragging) {
                            offsetX = dragStart.ox + (e.offsetX-dragStart.x);
                            offsetY = dragStart.oy + (e.offsetY-dragStart.y);
                            draw();
                          }
                        };
                        document.getElementById('crop-zoom-in').onclick = function(){ zoom*=1.1; draw(); };
                        document.getElementById('crop-zoom-out').onclick = function(){ zoom/=1.1; draw(); };
                        document.getElementById('crop-aspect').onclick = function(){ aspectLock=!aspectLock; this.innerText=aspectLock?'Lock 4:1':'Free'; draw(); };
                        document.getElementById('crop-save').onclick = function(){ window._profileCoverDataUrl = cropper.toDataURL('image/jpeg'); cropper.classList.add('hidden'); document.getElementById('profile-cover-img').src = window._profileCoverDataUrl; document.getElementById('profile-cover-img').classList.remove('hidden'); document.getElementById('profile-cover-crop-controls').classList.add('hidden'); document.getElementById('profile-cover-preview').classList.add('hidden'); };
                      };
                      img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                  }
                };
              };
            }
            // Admin broadcast
            if (isAdmin) {
              if (!document.getElementById('broadcast-btn')) {
                const btn = document.createElement('button');
                btn.id = 'broadcast-btn';
                btn.className = 'ml-4 bg-purple-700 text-white px-4 py-2 rounded-full font-bold shadow hover:scale-105 transition';
                btn.innerText = 'Broadcast Message';
                btn.onclick = function() {
                  document.getElementById('broadcast-modal').classList.remove('hidden');
                };
                document.querySelector('.flex-1').appendChild(btn);
              }
              document.getElementById('broadcast-send-btn').onclick = function() {
                const msg = document.getElementById('broadcast-input').value.trim();
                if (msg) {
                  localStorage.setItem('community_broadcast', msg);
                  document.getElementById('broadcast-modal').classList.add('hidden');
                  document.getElementById('broadcast-input').value = '';
                  showBroadcastBanner();
                }
              };
            }
            function showBroadcastBanner() {
              const msg = localStorage.getItem('community_broadcast');
              const banner = document.getElementById('broadcast-banner');
              if (msg) {
                banner.innerText = msg;
                banner.classList.remove('hidden');
                setTimeout(()=>banner.classList.add('hidden'), 8000);
              }
            }
            showBroadcastBanner();
            // ... leaderboard row ...
            if (isAdmin) {
              if (!document.getElementById('modlogs-btn')) {
                const btn = document.createElement('button');
                btn.id = 'modlogs-btn';
                btn.className = 'ml-4 bg-yellow-600 text-white px-4 py-2 rounded-full font-bold shadow hover:scale-105 transition';
                btn.innerText = 'Moderation Logs';
                btn.onclick = function() {
                  document.getElementById('modlogs-modal').classList.remove('hidden');
                  renderModLogs();
                };
                document.querySelector('.flex-1').appendChild(btn);
              }
            }
            function addModLog(user, action, duration) {
              const logs = JSON.parse(localStorage.getItem('mod_logs')||'[]');
              logs.unshift({user, action, date:new Date().toISOString(), duration});
              localStorage.setItem('mod_logs', JSON.stringify(logs));
            }
            function renderModLogs() {
              const logs = JSON.parse(localStorage.getItem('mod_logs')||'[]');
              const table = document.getElementById('modlogs-table');
              if (table) {
                table.innerHTML = logs.map(l=>`<tr><td class='py-1 px-3'>${l.user}</td><td class='py-1 px-3'>${l.action}</td><td class='py-1 px-3'>${l.date.split('T')[0]}</td><td class='py-1 px-3'>${l.duration}</td></tr>`).join('');
              }
            }
          }
        }
      }
      renderCertificates();
    });

    // Lesson Modal Logic
    const lessons = [
      {
        id: 1,
        title: 'Day 1: Foundations of Faith',
        status: 'Completed',
        description: 'Understanding salvation, grace, and your new identity in Christ.',
        time: '45 min',
        quiz: '95%',
        checklist: [
          { text: 'Read the lesson passage', done: true },
          { text: 'Watch the lesson video', done: true },
          { text: 'Complete the quiz', done: true },
        ]
      },
      {
        id: 2,
        title: 'Day 2: Prayer & Devotion',
        status: 'In Progress',
        description: 'Building a daily habit of prayer, worship, and Bible study.',
        time: '30 min',
        quiz: '60%',
        checklist: [
          { text: 'Read the lesson passage', done: true },
          { text: 'Watch the lesson video', done: false },
          { text: 'Complete the quiz', done: false },
        ]
      },
    ];
    function showLessonModal(id) {
      const lesson = lessons.find(l => l.id === id);
      if (!lesson) return;
      let checklistHtml = lesson.checklist.map((item, idx) => `
        <li class="flex items-center gap-2 mb-2">
          <input type="checkbox" ${item.done ? 'checked' : ''} disabled class="form-checkbox h-5 w-5 text-blue-600 rounded" />
          <span class="${item.done ? 'line-through text-gray-400' : ''}">${item.text}</span>
        </li>
      `).join('');
      document.getElementById('lesson-modal-content').innerHTML = `
        <h2 class="text-xl font-bold text-blue-900 mb-2">${lesson.title}</h2>
        <div class="text-sm text-gray-600 mb-4">${lesson.description}</div>
        <div class="flex items-center gap-4 mb-4">
          <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-semibold">${lesson.status}</span>
          <span class="flex items-center gap-1 text-xs text-gray-600"><i class='fa fa-clock'></i> ${lesson.time}</span>
          <span class="flex items-center gap-1 text-xs text-gray-600"><i class='fa fa-clipboard-check'></i> Quiz: ${lesson.quiz}</span>
        </div>
        <div class="mb-4">
          <h3 class="font-bold text-blue-900 mb-2">Checklist</h3>
          <ul>${checklistHtml}</ul>
        </div>
        <button class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition text-sm">Mark as Complete</button>
      `;
      document.getElementById('lesson-modal').classList.remove('hidden');
    }
    function closeLessonModal() {
      document.getElementById('lesson-modal').classList.add('hidden');
    }

    // Certificates logic for student portal
    function getCertificates() {
      return JSON.parse(localStorage.getItem('discipleship_certificates') || '[]');
    }
    function getCurrentUser() {
      try {
        return JSON.parse(localStorage.getItem('discipleship_logged_in_user'));
      } catch (e) { return null; }
    }
    function renderCertificates() {
      const user = getCurrentUser();
      const certificates = getCertificates().filter(c => c.user === user.name || c.email === user.email);
      const list = document.getElementById('certificates-list');
      if (!list) return;
      list.innerHTML = '';
      if (!certificates.length) {
        list.innerHTML = '<div class="text-gray-500">No certificates yet. Complete a course to earn your first certificate!</div>';
        return;
      }
      certificates.forEach((cert, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-br from-gold/10 to-purple/10 border border-gold rounded-xl p-6 shadow w-80 flex flex-col gap-2';
        card.innerHTML = `
          <div class="flex items-center gap-3 mb-2">
            <i class="fa fa-certificate text-gold text-2xl"></i>
            <div class="font-bold text-blue-900 text-lg">${cert.course}</div>
          </div>
          <div class="text-sm text-gray-700">Issued: <span class="font-semibold">${cert.date}</span></div>
          <div class="text-xs text-gray-500">Certificate ID: <span class="font-mono">${cert.id || ''}</span></div>
          <div class="text-xs text-gray-500">Status: <span class="font-semibold">${cert.status}</span></div>
          <button class="btn-gold px-4 py-2 rounded-lg font-semibold mt-2" onclick="previewCertificate(${idx})"><i class='fa fa-eye'></i> View / Download</button>
        `;
        list.appendChild(card);
      });
    }
    // Certificate preview modal logic (same as admin)
    window.previewCertificate = function(idx) {
      const user = getCurrentUser();
      const certificates = getCertificates().filter(c => c.user === user.name || c.email === user.email);
      const cert = certificates[idx];
      const certificatePreviewModal = document.getElementById('certificate-preview-modal');
      const certificatePreviewContent = document.getElementById('certificate-preview-content');
      const downloadCertificateBtn = document.getElementById('download-certificate-btn');
      const downloadCertificatePdfBtn = document.getElementById('download-certificate-pdf-btn');
      certificatePreviewModal.classList.remove('hidden');
      
      // Add fallback download function for user portal
      window.downloadCertificateSimple = function() {
        const certCanvas = document.getElementById('certificate-canvas');
        if (!certCanvas) {
          alert('Certificate not found. Please try again.');
          return;
        }
        
        // Create a simple text-based certificate as fallback
        const certificateText = `
CERTIFICATE OF COMPLETION

This certifies that ${cert.user} has successfully completed the course "${cert.course}" on ${cert.date}.

Certificate ID: ${cert.id}
Status: ${cert.status}
Signature: ${cert.signature || 'Rev. John Smith'}
Title: ${cert.title || 'Director'}

¬© 2025 Hearts After God Ministry
        `;
        
        const blob = new Blob([certificateText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `certificate-${cert.user.replace(/\s+/g,'_')}-${cert.course.replace(/\s+/g,'_')}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      };
      // Generate QR code with verification URL
      const baseUrl = 'https://heartsaftergod.org/verify';
      const params = new URLSearchParams({
        user: cert.user,
        course: cert.course,
        date: cert.date,
        id: cert.id
      });
      const qrUrl = `${baseUrl}?${params.toString()}`;
      // Preload the logo image
      const logoImg = new Image();
      logoImg.crossOrigin = 'anonymous';
      logoImg.onload = function() {
        console.log('Logo image loaded successfully');
        // Generate QR code after logo is loaded
        setTimeout(() => {
          const qrElement = document.getElementById('certificate-qr');
          if (qrElement && typeof QRious !== 'undefined') {
            const qr = new QRious({
              element: qrElement,
              value: qrUrl,
              size: 60,
              background: 'white',
              foreground: '#7C3AED',
              level: 'H',
            });
            console.log('QR code generated successfully');
          } else {
            console.error('QR code element or library not found');
          }
        }, 100);
      };
      logoImg.onerror = function() {
        console.log('Logo image failed to load, using fallback');
        // Show fallback logo
        const logoElement = document.getElementById('certificate-logo');
        const fallbackElement = document.getElementById('logo-fallback');
        if (logoElement && fallbackElement) {
          logoElement.style.display = 'none';
          fallbackElement.style.display = 'flex';
        }
        // Generate QR code anyway
        setTimeout(() => {
          const qrElement = document.getElementById('certificate-qr');
          if (qrElement && typeof QRious !== 'undefined') {
            const qr = new QRious({
              element: qrElement,
              value: qrUrl,
              size: 60,
              background: 'white',
              foreground: '#7C3AED',
              level: 'H',
            });
            console.log('QR code generated successfully');
          } else {
            console.error('QR code element or library not found');
          }
        }, 100);
      };
              logoImg.src = 'assets/images/WhatsApp Image 2025-07-04 at 17.27.34_37ced412.jpg';
      // Create a certificate with logo and QR code for better html2canvas compatibility
      certificatePreviewContent.innerHTML = `
        <div id="certificate-canvas" class="w-full max-w-lg bg-white border-4 border-gold rounded-lg p-8 flex flex-col items-center text-center" style="min-width:400px; min-height:500px; font-family: Arial, sans-serif;">
          <!-- Header with Logo -->
          <div class="w-full text-center mb-6">
            <div class="flex items-center justify-center mb-4">
              <img id="certificate-logo" src="assets/images/WhatsApp Image 2025-07-04 at 17.27.34_37ced412.jpg" alt="Logo" class="w-16 h-16 rounded-full border-2 border-gold mr-4" style="object-fit: cover; background: #F59E0B;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
              <div id="logo-fallback" class="w-16 h-16 rounded-full border-2 border-gold mr-4 bg-gold flex items-center justify-center text-white font-bold text-lg" style="display: none;">HAG</div>
              <div>
                <div class="text-2xl font-bold text-gold">Hearts After God Ministry</div>
                <div class="text-sm text-gray-600">Discipleship Program</div>
              </div>
            </div>
            <div class="text-3xl font-bold text-purple mb-4">Certificate of Completion</div>
          </div>
          
          <!-- Main Content -->
          <div class="flex-1 flex flex-col justify-center items-center text-center">
            <p class="text-lg mb-4">This certifies that</p>
            <div class="text-3xl font-bold text-purple mb-4">${cert.user}</div>
            <p class="text-lg mb-4">has successfully completed the course</p>
            <div class="text-2xl font-bold text-blue mb-4">${cert.course}</div>
            <p class="text-lg mb-4">on</p>
            <div class="text-xl font-bold mb-4">${cert.date}</div>
          </div>
          
          <!-- Footer with QR Code and Certificate ID -->
          <div class="w-full mt-8">
            <div class="flex justify-between items-end">
              <div class="text-center">
                <div class="text-lg font-bold text-purple mb-1">${cert.signature || 'Rev. John Smith'}</div>
                <div class="text-sm text-gray-600">${cert.title || 'Director'}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-gray-500 mb-2">Certificate ID:</div>
                <div class="text-xs font-mono text-gray-700 mb-2">${cert.id}</div>
                <canvas id="certificate-qr" style="width:60px;height:60px;border:1px solid #ddd;"></canvas>
              </div>
              <div class="text-center">
                <div class="text-xs text-gray-500 mb-2">Status:</div>
                <div class="text-xs font-bold text-green-600">${cert.status}</div>
                <div class="text-xs text-gray-500 mt-2">Verified</div>
              </div>
            </div>
            <div class="text-center mt-4">
              <div class="text-xs text-gray-500">&copy; 2025 Hearts After God Ministry</div>
            </div>
          </div>
        </div>
      `;
      // Download logic (same as admin)
      downloadCertificateBtn.onclick = function() {
        const certCanvas = document.getElementById('certificate-canvas');
        if (!certCanvas) {
          alert('Certificate canvas not found. Please try again.');
          return;
        }
        
        downloadCertificateBtn.disabled = true;
        document.getElementById('download-png-text').classList.add('opacity-50');
        document.getElementById('download-png-spinner').classList.remove('hidden');
        
        // Check if html2canvas is available
        if (typeof html2canvas === 'undefined') {
          alert('Download library not loaded. Please refresh the page and try again.');
          downloadCertificateBtn.disabled = false;
          document.getElementById('download-png-text').classList.remove('opacity-50');
          document.getElementById('download-png-spinner').classList.add('hidden');
          return;
        }
        
        html2canvas(certCanvas, {
          backgroundColor: '#ffffff',
          scale: 1,
          useCORS: true,
          allowTaint: true,
          logging: true,
          width: certCanvas.offsetWidth,
          height: certCanvas.offsetHeight,
          imageTimeout: 5000
        }).then(canvas => {
          try {
            const link = document.createElement('a');
            link.download = `certificate-${cert.user.replace(/\s+/g,'_')}-${cert.course.replace(/\s+/g,'_')}.png`;
            link.href = canvas.toDataURL('image/png', 0.9);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            downloadCertificateBtn.disabled = false;
            document.getElementById('download-png-text').classList.remove('opacity-50');
            document.getElementById('download-png-spinner').classList.add('hidden');
          } catch (error) {
            console.error('Download error:', error);
            alert('Download failed. Please try again.');
            downloadCertificateBtn.disabled = false;
            document.getElementById('download-png-text').classList.remove('opacity-50');
            document.getElementById('download-png-spinner').classList.add('hidden');
          }
        }).catch(error => {
          console.error('Canvas generation error:', error);
          alert('Failed to generate certificate image. Please try again.');
          downloadCertificateBtn.disabled = false;
          document.getElementById('download-png-text').classList.remove('opacity-50');
          document.getElementById('download-png-spinner').classList.add('hidden');
        });
      };
      downloadCertificatePdfBtn.onclick = function() {
        const certCanvas = document.getElementById('certificate-canvas');
        if (!certCanvas) {
          alert('Certificate canvas not found. Please try again.');
          return;
        }
        
        downloadCertificatePdfBtn.disabled = true;
        document.getElementById('download-pdf-text').classList.add('opacity-50');
        document.getElementById('download-pdf-spinner').classList.remove('hidden');
        
        // Check if required libraries are available
        if (typeof html2canvas === 'undefined') {
          alert('Download library not loaded. Please refresh the page and try again.');
          downloadCertificatePdfBtn.disabled = false;
          document.getElementById('download-pdf-text').classList.remove('opacity-50');
          document.getElementById('download-pdf-spinner').classList.add('hidden');
          return;
        }
        
        if (typeof window.jspdf === 'undefined') {
          alert('PDF library not loaded. Please refresh the page and try again.');
          downloadCertificatePdfBtn.disabled = false;
          document.getElementById('download-pdf-text').classList.remove('opacity-50');
          document.getElementById('download-pdf-spinner').classList.add('hidden');
          return;
        }
        
        html2canvas(certCanvas, {
          backgroundColor: '#ffffff',
          scale: 1,
          useCORS: true,
          allowTaint: true,
          logging: true,
          width: certCanvas.offsetWidth,
          height: certCanvas.offsetHeight,
          imageTimeout: 5000
        }).then(canvas => {
          try {
            const imgData = canvas.toDataURL('image/png', 0.9);
            const pdf = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgProps = pdf.getImageProperties(imgData);
            let pdfWidth = pageWidth - 20;
            let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            if (pdfHeight > pageHeight - 20) {
              pdfHeight = pageHeight - 20;
              pdfWidth = (imgProps.width * pdfHeight) / imgProps.height;
            }
            const x = (pageWidth - pdfWidth) / 2;
            const y = (pageHeight - pdfHeight) / 2;
            pdf.addImage(imgData, 'PNG', x, y, pdfWidth, pdfHeight);
            pdf.save(`certificate-${cert.user.replace(/\s+/g,'_')}-${cert.course.replace(/\s+/g,'_')}.pdf`);
            
            downloadCertificatePdfBtn.disabled = false;
            document.getElementById('download-pdf-text').classList.remove('opacity-50');
            document.getElementById('download-pdf-spinner').classList.add('hidden');
          } catch (error) {
            console.error('PDF generation error:', error);
            alert('PDF generation failed. Please try again.');
            downloadCertificatePdfBtn.disabled = false;
            document.getElementById('download-pdf-text').classList.remove('opacity-50');
            document.getElementById('download-pdf-spinner').classList.add('hidden');
          }
        }).catch(error => {
          console.error('Canvas generation error:', error);
          alert('Failed to generate certificate image. Please try again.');
          downloadCertificatePdfBtn.disabled = false;
          document.getElementById('download-pdf-text').classList.remove('opacity-50');
          document.getElementById('download-pdf-spinner').classList.add('hidden');
        });
      };
    };
    function closeCertificatePreview() {
      document.getElementById('certificate-preview-modal').classList.add('hidden');
      document.getElementById('certificate-preview-content').innerHTML = '';
    }
    window.closeCertificatePreview = closeCertificatePreview;

    // =====================
    // User Announcements System
    // =====================
    (function() {
      let lastAnnouncementCount = 0;
      
      // Load announcements from localStorage (shared with admin)
      function loadAnnouncements() {
        return JSON.parse(localStorage.getItem('announcements') || '[]');
      }

      // Get priority color for user view
      function getPriorityColor(priority) {
        switch(priority) {
          case 'urgent': return 'bg-red-100 text-red-800 border-red-300';
          case 'high': return 'bg-orange-100 text-orange-800 border-orange-300';
          default: return 'bg-blue-100 text-blue-800 border-blue-300';
        }
      }

      // Render announcements for users
      function renderUserAnnouncements() {
        const announcements = loadAnnouncements();
        const container = document.getElementById('user-announcements-list');
        
        if (!container) return;
        
        if (announcements.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fa fa-bullhorn text-4xl mb-4 opacity-50"></i>
              <p class="text-lg">No announcements yet</p>
              <p class="text-sm">Check back soon for ministry updates!</p>
            </div>
          `;
          return;
        }
        
        // Filter only active announcements (not scheduled for future)
        const now = new Date();
        const activeAnnouncements = announcements.filter(announcement => {
          if (announcement.status === 'scheduled') return false;
          if (announcement.schedule && new Date(announcement.schedule) > now) return false;
          return true;
        });
        
        if (activeAnnouncements.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fa fa-clock text-4xl mb-4 opacity-50"></i>
              <p class="text-lg">No active announcements</p>
              <p class="text-sm">Check back later for new updates!</p>
            </div>
          `;
          return;
        }
        
        // Sort: pinned first, then by timestamp
        const sortedAnnouncements = activeAnnouncements
          .slice()
          .sort((a, b) => (b.pinned - a.pinned) || (b.timestamp - a.timestamp));
        
        container.innerHTML = sortedAnnouncements.map(announcement => {
          const priorityClass = getPriorityColor(announcement.priority || 'normal');
          
          return `
            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow ${announcement.pinned ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <h3 class="text-xl font-bold text-blue-900">${announcement.title}</h3>
                  ${announcement.pinned ? '<span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded text-xs font-semibold">üìå Pinned</span>' : ''}
                  <span class="px-2 py-1 ${priorityClass} rounded text-xs font-semibold border">${announcement.priority || 'normal'}</span>
                </div>
                <div class="text-xs text-gray-500">
                  ${new Date(announcement.timestamp).toLocaleDateString()}
                </div>
              </div>
              
              <div class="text-gray-700 mb-4 leading-relaxed whitespace-pre-wrap">${announcement.message}</div>
              
              ${announcement.attachment ? `
                <div class="mb-3 p-3 bg-gray-50 rounded border">
                  <div class="flex items-center gap-2">
                    <i class="fa fa-paperclip text-gray-500"></i>
                    <a href="${announcement.attachment.data}" download="${announcement.attachment.name}" 
                       class="text-blue-600 hover:text-blue-800 font-medium">
                      ${announcement.attachment.name}
                    </a>
                    <span class="text-xs text-gray-500">(Click to download)</span>
                  </div>
                </div>
              ` : ''}
              
              <div class="flex items-center justify-between text-xs text-gray-500">
                <span>From: Hearts After God Ministry</span>
                <span>${new Date(announcement.timestamp).toLocaleTimeString()}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Show notification for new announcements
      function showAnnouncementNotification(announcement) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-white border-l-4 border-gold shadow-lg rounded-lg p-4 max-w-sm z-50 transform transition-all duration-300 translate-x-full';
        notification.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
              <i class="fa fa-bullhorn text-gold text-xl"></i>
            </div>
            <div class="flex-1">
              <h4 class="font-semibold text-blue-900 mb-1">${announcement.title}</h4>
              <p class="text-sm text-gray-600 mb-2">${announcement.message.substring(0, 100)}${announcement.message.length > 100 ? '...' : ''}</p>
              <div class="flex items-center justify-between">
                <span class="text-xs text-gray-500">New announcement</span>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-red-500">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
          notification.classList.remove('translate-x-full');
        }, 100);
        
        // Auto remove after 8 seconds
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => notification.remove(), 300);
        }, 8000);
      }

      // Check for new announcements
      function checkForNewAnnouncements() {
        const announcements = loadAnnouncements();
        const now = new Date();
        const activeAnnouncements = announcements.filter(announcement => {
          if (announcement.status === 'scheduled') return false;
          if (announcement.schedule && new Date(announcement.schedule) > now) return false;
          return true;
        });
        
        if (activeAnnouncements.length > lastAnnouncementCount && lastAnnouncementCount > 0) {
          // New announcements found
          const newAnnouncements = activeAnnouncements.slice(0, activeAnnouncements.length - lastAnnouncementCount);
          newAnnouncements.forEach(announcement => {
            showAnnouncementNotification(announcement);
          });
        }
        
        lastAnnouncementCount = activeAnnouncements.length;
      }

      // Listen for storage changes (real-time sync)
      window.addEventListener('storage', function(e) {
        if (e.key === 'announcements') {
          renderUserAnnouncements();
          checkForNewAnnouncements();
        }
      });

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Initial render
        renderUserAnnouncements();
        checkForNewAnnouncements();
        
        // Check for new announcements every 30 seconds
        setInterval(() => {
          renderUserAnnouncements();
          checkForNewAnnouncements();
        }, 30000);
      });
    })();
    // =====================
    // End User Announcements System
    // =====================

    // =====================
    // User Support Ticket System
    // =====================
    (function() {
      // Load support tickets from localStorage
      function loadSupportTickets() {
        return JSON.parse(localStorage.getItem('support_tickets') || '[]');
      }

      // Save support tickets to localStorage
      function saveSupportTickets(tickets) {
        localStorage.setItem('support_tickets', JSON.stringify(tickets));
      }

      // Get current user
      function getCurrentUser() {
        try {
          return JSON.parse(localStorage.getItem('discipleship_logged_in_user'));
        } catch (e) { return null; }
      }

      // Get priority color
      function getPriorityColor(priority) {
        switch(priority) {
          case 'Urgent': return 'bg-red-100 text-red-800 border-red-300';
          case 'High': return 'bg-orange-100 text-orange-800 border-orange-300';
          case 'Medium': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
          default: return 'bg-green-100 text-green-800 border-green-300';
        }
      }

      // Get status color
      function getStatusColor(status) {
        switch(status) {
          case 'Open': return 'bg-red-100 text-red-800 border-red-300';
          case 'In Progress': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
          case 'Resolved': return 'bg-green-100 text-green-800 border-green-300';
          default: return 'bg-gray-100 text-gray-800 border-gray-300';
        }
      }

      // Render user tickets
      function renderUserTickets() {
        const user = getCurrentUser();
        if (!user) return;

        const tickets = loadSupportTickets().filter(ticket => 
          ticket.user === user.name || ticket.email === user.email
        );
        
        const container = document.getElementById('user-tickets-list');
        if (!container) return;

        if (tickets.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fa fa-ticket text-4xl mb-4 opacity-50"></i>
              <p class="text-lg">No support tickets yet</p>
              <p class="text-sm">Create your first ticket to get help!</p>
            </div>
          `;
          return;
        }

        // Sort by timestamp (newest first)
        tickets.sort((a, b) => b.timestamp - a.timestamp);

        container.innerHTML = tickets.map(ticket => {
          const priorityClass = getPriorityColor(ticket.priority || 'Low');
          const statusClass = getStatusColor(ticket.status || 'Open');
          
          return `
            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
              <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                  <h4 class="text-lg font-semibold text-blue-900 mb-1">${ticket.subject || 'No subject'}</h4>
                  <p class="text-gray-600 mb-2">${(ticket.description || '').substring(0, 150)}${(ticket.description || '').length > 150 ? '...' : ''}</p>
                </div>
                <div class="flex gap-2 ml-4">
                  <span class="px-2 py-1 rounded text-xs border ${priorityClass}">${ticket.priority || 'Low'}</span>
                  <span class="px-2 py-1 rounded text-xs border ${statusClass}">${ticket.status || 'Open'}</span>
                </div>
              </div>
              
              <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                <span>Created: ${new Date(ticket.timestamp).toLocaleDateString()}</span>
                <span>${new Date(ticket.timestamp).toLocaleTimeString()}</span>
              </div>

              ${ticket.replies && ticket.replies.length > 0 ? `
                <div class="bg-gray-50 p-3 rounded mb-3">
                  <div class="text-sm text-gray-600 mb-1">
                    <strong>Latest Reply:</strong> ${new Date(ticket.replies[ticket.replies.length - 1].timestamp).toLocaleString()}
                  </div>
                  <div class="text-gray-800">${ticket.replies[ticket.replies.length - 1].message}</div>
                </div>
              ` : ''}

              <button onclick="viewTicketDetails('${ticket.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                <i class="fa fa-eye mr-1"></i>View Details
              </button>
            </div>
          `;
        }).join('');
      }

      // Show support tickets section
      window.showSupportTickets = function() {
        document.getElementById('support-tickets-section').classList.remove('hidden');
        document.getElementById('faqs-section').classList.add('hidden');
        document.getElementById('resources-section').classList.add('hidden');
        renderUserTickets();
      };

      // Show FAQs section
      window.showFAQs = function() {
        document.getElementById('faqs-section').classList.remove('hidden');
        document.getElementById('support-tickets-section').classList.add('hidden');
        document.getElementById('resources-section').classList.add('hidden');
      };

      // Show resources section
      window.showResources = function() {
        document.getElementById('resources-section').classList.remove('hidden');
        document.getElementById('support-tickets-section').classList.add('hidden');
        document.getElementById('faqs-section').classList.add('hidden');
      };

      // View ticket details
      window.viewTicketDetails = function(ticketId) {
        const tickets = loadSupportTickets();
        const ticket = tickets.find(t => t.id === ticketId);
        if (!ticket) return;

        const modal = document.getElementById('ticket-detail-modal');
        const content = document.getElementById('ticket-detail-content');
        
        content.innerHTML = `
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded">
              <div class="grid md:grid-cols-2 gap-4 text-sm mb-3">
                <div><strong>Subject:</strong> ${ticket.subject || 'No subject'}</div>
                <div><strong>Priority:</strong> <span class="px-2 py-1 rounded text-xs ${getPriorityColor(ticket.priority || 'Low')}">${ticket.priority || 'Low'}</span></div>
                <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusColor(ticket.status || 'Open')}">${ticket.status || 'Open'}</span></div>
                <div><strong>Created:</strong> ${new Date(ticket.timestamp).toLocaleString()}</div>
              </div>
              <div>
                <strong>Description:</strong>
                <div class="mt-1 p-2 bg-white rounded border">${ticket.description || 'No description'}</div>
              </div>
            </div>

            ${ticket.replies && ticket.replies.length > 0 ? `
              <div>
                <h4 class="font-semibold text-blue-900 mb-2">Admin Replies</h4>
                ${ticket.replies.map(reply => `
                  <div class="bg-blue-50 p-3 rounded mb-2">
                    <div class="text-sm text-gray-600 mb-1">
                      <strong>Admin Reply</strong> - ${new Date(reply.timestamp).toLocaleString()}
                    </div>
                    <div class="text-gray-800">${reply.message}</div>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="text-gray-500 text-sm">No replies yet</p>'}
          </div>
        `;
        
        modal.classList.remove('hidden');
      };

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        // New ticket button
        const newTicketBtn = document.getElementById('new-ticket-btn');
        if (newTicketBtn) {
          newTicketBtn.onclick = function() {
            document.getElementById('new-ticket-form').classList.remove('hidden');
          };
        }

        // Cancel ticket button
        const cancelTicketBtn = document.getElementById('cancel-ticket-btn');
        if (cancelTicketBtn) {
          cancelTicketBtn.onclick = function() {
            document.getElementById('new-ticket-form').classList.add('hidden');
            document.getElementById('support-ticket-form').reset();
          };
        }

        // Close ticket modal
        const closeTicketModal = document.getElementById('close-ticket-modal');
        if (closeTicketModal) {
          closeTicketModal.onclick = function() {
            document.getElementById('ticket-detail-modal').classList.add('hidden');
          };
        }

        // Support ticket form submission
        const ticketForm = document.getElementById('support-ticket-form');
        if (ticketForm) {
          ticketForm.onsubmit = function(e) {
            e.preventDefault();
            
            const user = getCurrentUser();
            if (!user) {
              alert('Please log in to create a support ticket');
              return;
            }

            const subject = document.getElementById('ticket-subject').value.trim();
            const priority = document.getElementById('ticket-priority').value;
            const description = document.getElementById('ticket-description').value.trim();

            if (!subject || !description) {
              alert('Please fill in all required fields');
              return;
            }

            const newTicket = {
              id: 'ticket_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
              user: user.name,
              email: user.email,
              subject: subject,
              description: description,
              priority: priority,
              status: 'Open',
              timestamp: Date.now(),
              replies: []
            };

            const tickets = loadSupportTickets();
            tickets.unshift(newTicket);
            saveSupportTickets(tickets);

            // Reset form and hide
            ticketForm.reset();
            document.getElementById('new-ticket-form').classList.add('hidden');
            
            // Refresh tickets list
            renderUserTickets();
            
            alert('Support ticket created successfully! We will respond soon.');
          };
        }

        // Listen for storage changes (real-time updates)
        window.addEventListener('storage', function(e) {
          if (e.key === 'support_tickets') {
            renderUserTickets();
          }
        });
      });
    })();
    // =====================
    // End User Support Ticket System
    // =====================

    // Community logic for users (no admin controls)
    (function() {
      function getCurrentUser() {
        return JSON.parse(localStorage.getItem('discipleship_logged_in_user'));
      }
      function getAllUsers() {
        return JSON.parse(localStorage.getItem('discipleship_users') || '[]');
      }
      function getUserStatus(user) {
        if (user.banned) return 'Banned';
        if (user.muted) return 'Muted';
        return 'Active';
      }
      // Announcements
      const annKey = 'community_announcements';
      function getAnns() { return JSON.parse(localStorage.getItem(annKey)||'[]'); }
      // Chat
      const chatKey = 'community_chat_messages';
      function getChat() { return JSON.parse(localStorage.getItem(chatKey)||'[]'); }
      function setChat(msgs) { localStorage.setItem(chatKey, JSON.stringify(msgs)); }
      // Leaderboard
      function renderLeaderboard() {
        const users = getAllUsers();
        const progress = JSON.parse(localStorage.getItem('discipleship_progress')||'{}');
        const avatars = ['üßë‚Äçü¶±','üßëüèæ','üë©‚Äçü¶∞','üßë','üë®‚Äçü¶≥','üë©ÔøΩÔøΩ','üßëüèª','üë©‚Äçü¶≥'];
        const tbody = document.getElementById('community-leaderboard');
        if (!tbody) return;
        tbody.innerHTML = users.map((u,i)=>{
          const p = Object.values(progress).find(pr=>pr && pr.completedLessons && pr.userId ? pr.userId===u.id : u.email===getCurrentUser().email);
          const lessons = p && p.completedLessons ? p.completedLessons.length : 0;
          const badges = p && p.certificates ? p.certificates.length : 0;
          const status = getUserStatus(u);
          return `<tr${u.banned?" class='bg-red-50'":""}><td class='py-1 px-3 text-2xl'>${u.avatar||avatars[i%avatars.length]}</td><td class='py-1 px-3'>${u.name}</td><td class='py-1 px-3'>${lessons}</td><td class='py-1 px-3'>${badges}</td><td class='py-1 px-3'>${status}</td></tr>`;
        }).join('');
      }
      // Announcements
      function renderAnnouncements() {
        const anns = getAnns();
        const annList = document.getElementById('community-announcements');
        if (!annList) return;
        annList.innerHTML = anns.map((a) => `<li>${a.text} ${a.pinned?'<span class=\"text-gold font-bold ml-2\">[Pinned]</span>':''}</li>`).join('');
      }
      // Chat
      function renderChat() {
        const msgs = getChat();
        const user = getCurrentUser();
        const users = getAllUsers();
        const box = document.getElementById('community-chat-messages');
        if (!box) return;
        box.innerHTML = msgs.map((m) => {
          const u = users.find(u=>u.email===m.email);
          const status = u ? getUserStatus(u) : 'Active';
          return `<div class='flex gap-2 items-center${status==='Muted'?' opacity-50 pointer-events-none':''}${status==='Banned'?' hidden':''}'>
            <span class='font-bold text-blue-900'>${m.name}:</span>
            <span>${m.text}</span>
          </div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;
      }
      document.addEventListener('DOMContentLoaded', function() {
        renderLeaderboard();
        renderAnnouncements();
        renderChat();
        const chatForm = document.getElementById('community-chat-form');
        if (chatForm) {
          chatForm.onsubmit = function(e) {
            e.preventDefault();
            const user = getCurrentUser();
            if (!user) return false;
            const users = getAllUsers();
            const thisUser = users.find(u=>u.email===user.email);
            if (thisUser && (thisUser.muted || thisUser.banned)) return false;
            const input = document.getElementById('community-chat-input');
            const val = input.value.trim();
            if (val) {
              const msgs = getChat();
              msgs.push({ name: user.name, email: user.email, text: val });
              setChat(msgs);
              renderChat();
              input.value = '';
            }
          };
        }
      });
    })();

    // Animated underline logic
    const navLinks = document.querySelectorAll('#nav-links .nav-link');
    const navUnderline = document.getElementById('nav-underline');
    function moveUnderline(el) {
      if (!el) return;
      const rect = el.getBoundingClientRect();
      const parentRect = el.parentElement.parentElement.getBoundingClientRect();
      navUnderline.style.width = rect.width + 'px';
      navUnderline.style.left = (rect.left - parentRect.left) + 'px';
    }
    navLinks.forEach(link => {
      link.addEventListener('mouseenter', e => moveUnderline(e.target));
      link.addEventListener('focus', e => moveUnderline(e.target));
      link.addEventListener('mouseleave', () => {
        const active = document.querySelector('#nav-links .nav-link.active');
        moveUnderline(active);
      });
    });
    window.addEventListener('DOMContentLoaded', () => {
      const active = document.querySelector('#nav-links .nav-link.active');
      moveUnderline(active);
    });
  </script>
</body>
</html> 